"use strict";var Assets={floors:{},characters:{},load:function load(){this.loadFloors();this.loadCharacters()},loadFloors:function loadFloors(){var _this=this;var tile=new Image;tile.src="./textures/floor/grass.png";tile.onload=function(){_this.floors["grass"]=tile}},loadCharacters:function loadCharacters(){var _this2=this;var a=new Image;a.src="./textures/character/sam4stand.png";var b=new Image;b.src="./textures/character/sam4stand-blink.png";b.onload=function(){_this2.characters["sam4stand"]=a;_this2.characters["sam4stand-blink"]=b;game.loaded=true}},getFloor:function getFloor(floor){return this.floors[floor]},getCharacter:function getCharacter(c){return this.characters[c]}};"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Game=function(){function Game(){_classCallCheck(this,Game);console.log("Initializing Game...");this.socket=null;this.playerName=null;this.room=null;this.canvasCtx=null;this.loaded=false;this.fps=20;this.timestep=1e3/this.fps;this.lastFrameTimeMs=0;this.delta=0;this.d={x:0,y:0};this.initialPos={x:0,y:0};this.mouse=null;this.mousedown=false;this.getPlayerName()}_createClass(Game,[{key:"start",value:function start(){Assets.load();this.createChatPanel();this.socket=io();this.configureSocket();this.bindChatEvents();this.createCanvas();this.bindEvents();this.configGrid();requestAnimationFrame(this.gameLoop.bind(this))}},{key:"configGrid",value:function configGrid(){var c=this.canvasCtx.canvas;Grid.setOrigin(c.width/2,0);Grid.createDrawOrder()}},{key:"gameLoop",value:function gameLoop(timestamp){if(!this.loaded){this.lastFrameTimeMs=0}if(timestamp<this.lastFrameTimeMs+1e3/this.fps){requestAnimationFrame(this.gameLoop.bind(this));return}this.delta+=timestamp-this.lastFrameTimeMs;var fps=1e3/(timestamp-this.lastFrameTimeMs);this.fpsSpan.innerHTML="fps: "+Math.ceil(fps);this.lastFrameTimeMs=timestamp;this.d={x:0,y:0};var i=0;while(this.delta>=this.timestep){this.update();this.delta-=this.timestep;if(i++>150){this.panic();break}}this.draw();requestAnimationFrame(this.gameLoop.bind(this))}},{key:"update",value:function update(){if(this.mouse!==null){this.d.x+=this.mouse.clientX-this.initialPos.x;this.d.y+=this.mouse.clientY-this.initialPos.y;Grid.move(this.d);Grid.createDrawOrder();this.initialPos.x=this.mouse.clientX;this.initialPos.y=this.mouse.clientY;this.mouse=null}}},{key:"panic",value:function panic(){this.delta=0}},{key:"draw",value:function draw(){var ctx=this.canvasCtx;ctx.fillStyle="#010101";ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);if(this.room!==null){this.room.draw(ctx)}}},{key:"bindEvents",value:function bindEvents(){var _this=this;var canvas=document.getElementsByClassName("game-canvas")[0];var body=document.getElementsByTagName("body")[0];body.onresize=function(){canvas.height=canvas.clientHeight;canvas.width=canvas.clientWidth};canvas.onmousedown=function(e){_this.mousedown=true;_this.initialPos.x=e.clientX;_this.initialPos.y=e.clientY};document.onmousemove=function(e){if(_this.mousedown){_this.mouse=e}};document.onmouseup=function(e){_this.mousedown=false}}},{key:"createCanvas",value:function createCanvas(){var app=document.getElementById("app");var canvas=document.createElement("canvas");canvas.className="game-canvas";this.canvasCtx=canvas.getContext("2d");app.appendChild(canvas);canvas.height=canvas.clientHeight;canvas.width=canvas.clientWidth;this.fpsSpan=document.createElement("span");this.fpsSpan.style="position: absolute; right: 0; color: #ffffff;";this.fpsSpan.innerHTML="XX";app.appendChild(this.fpsSpan);this.playersSpan=document.createElement("span");this.playersSpan.style="position: absolute; right: 0; color: #ffffff;"+" top: "+this.fpsSpan.clientHeight+"px;";this.playersSpan.innerHTML="YY";app.appendChild(this.playersSpan)}},{key:"configureSocket",value:function configureSocket(){var _this2=this;this.socket.emit("new player",this.playerName);this.socket.on("chat message",function(chatMsg){_this2.addChatMessage(chatMsg.player,chatMsg.msg)});this.socket.on("rooms list",function(rooms){_this2.socket.emit("join room",rooms[0])});this.socket.on("room info",function(room){_this2.room=new Room(room);_this2.room.createPlayers();_this2.room.adaptGrid()});this.socket.on("online players",function(num_players){_this2.playersSpan.innerHTML="online: "+num_players})}},{key:"createChatPanel",value:function createChatPanel(){var app=document.getElementById("app");var chatC=document.createElement("div");chatC.className="game-chat";var chatMessagesC=document.createElement("div");chatMessagesC.className="game-chatMessagesContainer";var chatInputC=document.createElement("div");chatInputC.className="game-chatInput";this.chatInput=document.createElement("input");this.chatInput.type="text";chatInputC.appendChild(this.chatInput);chatC.appendChild(chatMessagesC);chatC.appendChild(chatInputC);app.appendChild(chatC)}},{key:"bindChatEvents",value:function bindChatEvents(){var _this3=this;this.chatInput.onkeypress=function(e){var msg=_this3.chatInput.value.trim();if(e.keyCode===13&&msg!==""){_this3.chatInput.value="";_this3.socket.emit("chat message",msg);_this3.addChatMessage(_this3.playerName,msg)}}}},{key:"addChatMessage",value:function addChatMessage(player,msg){var msgC=document.createElement("div");msgC.className="game-chatMessage";var msgSpan=document.createElement("span");var nameSpan=document.createElement("span");nameSpan.className="game-boldText";nameSpan.textContent=player+": ";var msgNode=document.createTextNode(msg);msgSpan.appendChild(nameSpan);msgSpan.appendChild(msgNode);msgC.appendChild(msgSpan);var chat=document.getElementsByClassName("game-chatMessagesContainer")[0];chat.appendChild(msgC);chat.scrollTop=chat.scrollHeight}},{key:"getPlayerName",value:function getPlayerName(){var _this4=this;var app=document.getElementById("app");var menu=document.createElement("div");menu.className="game-centered";var nickContainer=document.createElement("div");nickContainer.className="game-horizontalLayout";var nickLabel=document.createElement("div");nickLabel.className="game-horizontalLayout";var nickSpan=document.createElement("span");nickSpan.className="game-label";nickSpan.innerHTML="Nickname:";var nickInputContainer=document.createElement("div");nickInputContainer.className="game-horizontalLayout";var nickInput=document.createElement("input");nickInput.type="text";var buttonC=document.createElement("div");buttonC.className="game-horizontalLayout";var button=document.createElement("button");button.className="game-horizontalCentered";button.innerHTML="Play";button.onclick=function(){var nick=nickInput.value.trim();if(nick!==""){_this4.playerName=nick;app.innerHTML="";_this4.start()}};menu.onkeydown=function(e){if(e.keyCode===13){button.onclick()}};nickLabel.appendChild(nickSpan);nickInputContainer.appendChild(nickInput);nickContainer.appendChild(nickLabel);nickContainer.appendChild(nickInputContainer);buttonC.appendChild(button);menu.appendChild(nickContainer);menu.appendChild(buttonC);app.appendChild(menu);nickInput.focus()}}]);return Game}();"use strict";var Grid={size:40,originX:0,originY:0,tileW:65,tileL:39,dx:32,dy:16,drawOrdered:[],setSize:function setSize(size){this.size=size},setOrigin:function setOrigin(x,y){this.originX=x-this.dx;this.originY=y},move:function move(d){this.originX+=d.x;this.originY+=d.y},getDrawOrdered:function getDrawOrdered(){return this.drawOrdered},createDrawOrder:function createDrawOrder(){this.drawOrdered=[];var x0=this.originX;var y0=this.originY;var drawX=void 0;var drawY=y0;var i=void 0;var j=void 0;for(var n=0;n<2*this.size-1;++n){if(n<this.size){i=0;j=this.size-1-n;drawX=x0-n*this.dx}else{i=n-this.size+1;j=0;drawX=x0-(2*this.size-n-2)*this.dx}while(i<this.size&&j<this.size){var pos={x:j,y:i,drawPos:{x:drawX,y:drawY}};this.drawOrdered.push(pos);++i;++j;drawX+=this.tileW}drawY+=this.dy}}};"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Player=function(){function Player(player){_classCallCheck(this,Player);this.name=player.name;this.room=player.room||null;this.pos=player.pos||null;this.adjustY=6;this.status="stand";this.direction=4;this.animFrame=0}_createClass(Player,[{key:"setRoom",value:function setRoom(room){this.room=room}},{key:"setPos",value:function setPos(pos){this.pos=pos}},{key:"getName",value:function getName(){return this.name}},{key:"getRoom",value:function getRoom(){return this.room}},{key:"getPos",value:function getPos(){return this.pos}},{key:"draw",value:function draw(ctx,drawPos){var floorHeight=Assets.getFloor("grass").height;var stand=Assets.getCharacter("sam4stand");var blink=Assets.getCharacter("sam4stand-blink");var newY=drawPos.y-stand.height+floorHeight-this.adjustY;if(this.animFrame<100){ctx.drawImage(stand,drawPos.x,newY)}else{ctx.drawImage(blink,drawPos.x,newY)}++this.animFrame;if(this.animFrame===106){this.animFrame=0}}}]);return Player}();if(typeof module!=="undefined"){module.exports=Player}"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Room=function(){function Room(room){_classCallCheck(this,Room);this.name=room.name;this.size=room.size;this.array=room.array;this.spawn=room.spawn||{x:0,y:0};this.players=room.players||{}}_createClass(Room,[{key:"setName",value:function setName(name){this.name=name}},{key:"setSize",value:function setSize(size){this.size=size}},{key:"setSpawn",value:function setSpawn(x,y){this.spawn={x:x,y:y}}},{key:"join",value:function join(player){this.players[player.getName()]=player;player.setRoom(this.name);player.setPos(this.spawn);var tile=this.array[this.spawn.y][this.spawn.x];tile.players.push(player.getName());this.array[this.spawn.y][this.spawn.x]=tile}},{key:"leave",value:function leave(playerName){var p=this.players[playerName];var tile=this.array[p.getPos().y][p.getPos().x];var i=tile.players.indexOf(playerName);tile.players.splice(i,1);this.array[p.getPos().y][p.getPos().x]=tile;this.players[playerName].setRoom(null);this.players[playerName].setPos(null);delete this.players[playerName]}},{key:"clear",value:function clear(){for(var player in this.players){this.leave(player)}}},{key:"getName",value:function getName(){return this.name}},{key:"getSize",value:function getSize(){return this.size}},{key:"getSpawn",value:function getSpawn(){return this.spawn}},{key:"getPlayers",value:function getPlayers(){return this.players}},{key:"createPlayers",value:function createPlayers(){for(var p in this.players){this.players[p]=new Player(this.players[p])}}},{key:"adaptGrid",value:function adaptGrid(){Grid.setSize(this.size);Grid.createDrawOrder()}},{key:"draw",value:function draw(ctx){var drawO=Grid.getDrawOrdered();var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=drawO[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var tile=_step.value;var cell=this.array[tile.y][tile.x];if(cell!==null){var img=Assets.getFloor(cell.material);ctx.drawImage(img,tile.drawPos.x,tile.drawPos.y)}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=drawO[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var _tile=_step2.value;var _cell=this.array[_tile.y][_tile.x];if(_cell!==null&&Array.isArray(_cell.players)){var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=_cell.players[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var player=_step3.value;this.players[player].draw(ctx,_tile.drawPos)}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}}]);return Room}();if(typeof module!=="undefined"){module.exports=Room}
