"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Assets={images:{},imgLoaded:0,imgFiles:[],load:function(){this.fillFileArrays(),this.loadImages()},loadImages:function(){var e=this,t=new Image;t.src=this.imgFiles[this.imgLoaded],t.onload=function(){var s=t.src.split("/"),a=s[s.length-1].split(".")[0];e.images[a]=t,++e.imgLoaded,e.imgLoaded<e.imgFiles.length?e.loadImages():game.startGame()}},getImage:function(e){return this.images[e]},getImgArray:function(e){var t=[];for(var s in this.images)0===s.indexOf(e)&&t.push(this.images[s]);return t},fillFileArrays:function(){var e="./textures/floor/";this.imgFiles.push(e+"grass.png"),e="./textures/character/",this.imgFiles.push(e+"sam0stand.png"),this.imgFiles.push(e+"sam0walk-1.png"),this.imgFiles.push(e+"sam0walk-2.png"),this.imgFiles.push(e+"sam0walk-3.png"),this.imgFiles.push(e+"sam0walk-4.png"),this.imgFiles.push(e+"sam1stand.png"),this.imgFiles.push(e+"sam1walk-1.png"),this.imgFiles.push(e+"sam1walk-2.png"),this.imgFiles.push(e+"sam1walk-3.png"),this.imgFiles.push(e+"sam1walk-4.png"),this.imgFiles.push(e+"sam2stand.png"),this.imgFiles.push(e+"sam2walk-1.png"),this.imgFiles.push(e+"sam2walk-2.png"),this.imgFiles.push(e+"sam2walk-3.png"),this.imgFiles.push(e+"sam2walk-4.png"),this.imgFiles.push(e+"sam3stand-1.png"),this.imgFiles.push(e+"sam3stand-2.png"),this.imgFiles.push(e+"sam3walk-1.png"),this.imgFiles.push(e+"sam3walk-2.png"),this.imgFiles.push(e+"sam3walk-3.png"),this.imgFiles.push(e+"sam3walk-4.png"),this.imgFiles.push(e+"sam4stand-1.png"),this.imgFiles.push(e+"sam4stand-2.png"),this.imgFiles.push(e+"sam4walk-1.png"),this.imgFiles.push(e+"sam4walk-2.png"),this.imgFiles.push(e+"sam4walk-3.png"),this.imgFiles.push(e+"sam4walk-4.png"),this.imgFiles.push(e+"sam5stand-1.png"),this.imgFiles.push(e+"sam5stand-2.png"),this.imgFiles.push(e+"sam5walk-1.png"),this.imgFiles.push(e+"sam5walk-2.png"),this.imgFiles.push(e+"sam5walk-3.png"),this.imgFiles.push(e+"sam6stand-1.png"),this.imgFiles.push(e+"sam6stand-2.png"),this.imgFiles.push(e+"sam6walk-1.png"),this.imgFiles.push(e+"sam6walk-2.png"),this.imgFiles.push(e+"sam6walk-3.png"),this.imgFiles.push(e+"sam6walk-4.png"),this.imgFiles.push(e+"sam7stand-1.png"),this.imgFiles.push(e+"sam7stand-2.png"),this.imgFiles.push(e+"sam7walk-1.png"),this.imgFiles.push(e+"sam7walk-2.png"),this.imgFiles.push(e+"sam7walk-3.png"),this.imgFiles.push(e+"sam7walk-4.png"),this.imgFiles.push(e+"shadow.png")}},_createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}(),CanvasChat=function(){function e(){_classCallCheck(this,e),this.players={},this.msgs=[],this.vel=1.5,this.t=-1,this.adjustX=32,this.moveUp=23,this.maxW=345;var t=document.getElementById("app");this.chat=document.createElement("div"),this.chat.style.width=t.clientWidth+"px",this.chat.style.height=t.clientHeight+"px",this.defaultY=t.clientHeight/3,this.chat.id="canvasChat",this.chat.style.position="absolute",this.chat.style.zIndex="1",this.chat.style.pointerEvents="none",t.appendChild(this.chat)}return _createClass(e,[{key:"add",value:function(e){e.html.style.position="fixed";var t=e.html.getElementsByClassName("game-chatMessage")[0];t.style.left="0",t.style.fontSize="14px",t.style.maxWidth=this.maxW-18+"px",t.style.pointerEvents="auto",this.chat.appendChild(e.html);var s=t.getBoundingClientRect();e.html.style.width=s.width+"px",e.html.style.height=s.height+"px",e.width=s.width,e.height=s.height,e.dy=-e.height,e.dx=this.adjustX-e.width/2,e.pos=this.players[e.player].pos,delete e.player,delete e.text,this.msgs.length>0&&(this.move(e,-1),this.clean()),this.msgs.push(e)}},{key:"touch",value:function(e,t){var s=Grid.drawPos[e.pos.y][e.pos.x],a=Grid.drawPos[t.pos.y][t.pos.x];if(s={x:s.x+e.dx,y:e.dy},(a={x:a.x+t.dx,y:t.dy}).y<s.y&&a.y+t.height>s.y||a.y<s.y+e.height&&a.y+t.height>=s.y+e.height||a.y>=s.y&&a.y+t.height<=s.y+e.height){if(s.x<a.x&&s.x+e.width>a.x)return!0;if(s.x<a.x+t.width&&s.x+e.width>a.x+t.width)return!0;if(s.x>=a.x&&s.x+e.width<=a.x+t.width)return!0}return!1}},{key:"move",value:function(e,t){for(var s=0;s<this.msgs.length;++s)if(s!==t&&this.touch(e,this.msgs[s])){var a=this.msgs[s];a.dy,a.height,e.dy,e.height;this.msgs[s].dy=e.dy-this.msgs[s].height,this.move(this.msgs[s],s)}}},{key:"clean",value:function(){for(var e=0;e<this.msgs.length;++e)this.msgs[e].dy+this.msgs[e].height<=-this.defaultY&&(this.chat.removeChild(this.msgs[e].html),this.msgs.splice(e,1),--e)}},{key:"update",value:function(){if(++this.t,this.t>=360/this.vel){var e=!0,t=!1,s=void 0;try{for(var a,i=this.msgs[Symbol.iterator]();!(e=(a=i.next()).done);e=!0)a.value.dy-=this.moveUp}catch(e){t=!0,s=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw s}}this.t=0,this.clean()}}},{key:"draw",value:function(){if(this.msgs.length>0){var e=!0,t=!1,s=void 0;try{for(var a,i=this.msgs[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){var n=a.value,l=Grid.drawPos[n.pos.y][n.pos.x];n.html.style.left=l.x+n.dx+"px",n.html.style.top=this.defaultY+n.dy+"px"}}catch(e){t=!0,s=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw s}}}}},{key:"clear",value:function(){this.msgs=[],this.chat.innerHTML=""}}]),e}(),_createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}(),Game=function(){function e(){_classCallCheck(this,e),this.player=null,this.room=null,this.roomsList=null,this.maxMsgLength=136,this.maxNickLength=15,this.delta=0,this.fps=60,this.timestep=1e3/this.fps,this.lastFrameTimeMs=0,this.frame=null,this.socket=io({reconnection:!1}),this.canvasCtx=null,this.minChatWidth=150,this.d={x:0,y:0},this.initialPos={x:0,y:0},this.mouse=null,this.mousedown=!1,this.disableClick=!1,this.resizedown=!1,this.receiveRoom=!1,this.configureSocket(),this.getPlayerName()}return _createClass(e,[{key:"joinRoom",value:function(e){if(null===this.room){this.createChatPanel(),this.bindChatEvents(),this.createCanvas(),this.bindEvents(),this.canvasChat=new CanvasChat;var t=document.getElementById("app");t.style.backgroundImage="none",t.style.backgroundColor="#010101",this.leaveB.style.display="inline-block",this.receiveRoom=!0,this.frame=requestAnimationFrame(this.gameLoop.bind(this))}else this.addChatInfoMessage("You left "+this.room.name);this.socket.emit("join room",e),this.addChatInfoMessage("You joined "+e)}},{key:"leaveRoom",value:function(){this.socket.emit("leave room"),this.receiveRoom=!1,this.canvasChat=null,this.room=null,this.leaveB.style.display="none",cancelAnimationFrame(this.frame),this.frame=null,this.fpsSpan.innerHTML="fps: 0";var e=document.getElementById("app"),t=document.getElementsByClassName("game-chat")[0],s=document.getElementsByClassName("game-chatResize")[0],a=document.getElementsByClassName("game-hideChatButton")[0],i=document.getElementsByClassName("game-canvas")[0],n=document.getElementsByClassName("game-chatInput")[0],l=document.getElementsByClassName("game-menu")[0],r=document.getElementById("canvasChat");e.removeChild(t),e.removeChild(s),e.removeChild(a),e.removeChild(i),l.removeChild(n),e.removeChild(r),e.style.backgroundImage='url("../textures/misc/background.jpg")',e.style.backgroundColor="#10436f"}},{key:"startGame",value:function(){this.createMenu()}},{key:"gameLoop",value:function(e){var t=e-this.lastFrameTimeMs;if(this.delta+=t,this.lastFrameTimeMs=e,this.delta>=this.timestep){var s=1e3/t;for(this.fpsSpan.innerHTML="fps: "+parseInt(s);this.delta>=this.timestep;)this.update(),this.delta-=this.timestep;this.draw()}this.frame=requestAnimationFrame(this.gameLoop.bind(this))}},{key:"update",value:function(){null!==this.room&&(this.room.updateLogic(),this.canvasChat.update()),this.d={x:0,y:0},null!==this.mouse&&(this.d.x+=this.mouse.clientX-this.initialPos.x,this.d.y+=this.mouse.clientY-this.initialPos.y,Grid.move(this.d),Grid.createDrawOrder(),this.initialPos.x=this.mouse.clientX,this.initialPos.y=this.mouse.clientY,this.mouse=null)}},{key:"draw",value:function(){var e=this.canvasCtx;e.fillStyle="#010101",e.fillRect(0,0,e.canvas.width,e.canvas.height),null!==this.room&&(this.room.draw(e),this.canvasChat.draw())}},{key:"bindEvents",value:function(){var e=this,t=document.getElementsByClassName("game-canvas")[0],s=document.getElementsByTagName("body")[0];s.onresize=function(){t.height=t.clientHeight,t.width=t.clientWidth,Grid.center(t.width,t.height),Grid.createDrawOrder(),e.canvasChat.chat.height=t.height,e.canvasChat.chat.width=t.width,e.canvasChat.defaultY=t.height/3};var a=document.getElementsByClassName("game-chatResize")[0],i=document.getElementsByClassName("game-chat")[0],n=document.getElementsByClassName("game-hideChatButton")[0],l=document.getElementsByClassName("game-chatMessagesContainer")[0];a.onmousedown=function(t){e.resizedown=!0,e.xIni=t.clientX},t.onmousedown=function(t){e.mousedown=!0,e.initialPos.x=t.clientX,e.initialPos.y=t.clientY},document.onmousemove=function(t){if(e.mousedown)window.getSelection().removeAllRanges(),e.mouse=t,e.disableClick=!0;else if(e.resizedown){i.style.transition="none",n.style.transition="none",window.getSelection().removeAllRanges();var r=t.clientX-e.xIni,h=i.getBoundingClientRect().width+r;h<e.minChatWidth?h=e.minChatWidth:h+5>s.clientWidth&&(h=s.clientWidth-5);var o=h-5;i.style.width=h+"px",a.style.left=o+"px",n.style.left=h+"px",l.scrollTop=l.scrollHeight,e.xIni=t.clientX}},document.onmouseup=function(t){e.mousedown=!1,e.resizedown=!1},t.onclick=function(t){if(!e.disableClick){var s=Grid.cellAt(t.clientX,t.clientY);null!==s&&e.socket.emit("click",s)}e.disableClick=!1}}},{key:"createCanvas",value:function(){var e=document.getElementById("app"),t=document.createElement("canvas");t.className="game-canvas",this.canvasCtx=t.getContext("2d"),e.appendChild(t),t.height=t.clientHeight,t.width=t.clientWidth}},{key:"configureSocket",value:function(){var e=this;this.socket.on("check name",function(t){t.res?(e.player=new Player({name:t.name,client:!0}),document.getElementById("app").innerHTML="",e.createInfoSpans(),Assets.load(),e.socket.emit("new player",e.player.name)):1===t.errno?alert("Name must be 4 to 15 characters long."):2===t.errno?alert("Your name can only contain characters: a-Z, 0-9, - , _ , : and ."):3===t.errno&&alert("Your name is being used by another player.")}),this.socket.on("chat message",function(t){e.addChatMessage(t)}),this.socket.on("online players",function(t){e.playersSpan.innerHTML="online: "+t}),this.socket.on("rooms list",function(t){e.roomsList=t,e.createRoomsWindow()}),this.socket.on("room info",function(t){e.receiveRoom&&(null===e.room||t.name!==e.room.name?(e.room=new Room({client:!0}),e.room.update(t),e.player=e.room.players[e.player.name],Grid.size=e.room.size,Grid.center(e.canvasCtx.canvas.width,e.canvasCtx.canvas.height),Grid.createDrawOrder(),e.canvasChat.clear()):e.room.update(t),e.canvasChat.players=e.room.players)}),this.socket.on("player join",function(t){e.addChatInfoMessage(t+" joined the room")}),this.socket.on("player left",function(t){e.addChatInfoMessage(t+" left the room")})}},{key:"createRoomsWindow",value:function(){var e=this,t=document.getElementById("app"),s=document.createElement("div");s.className="game-window";var a=document.createElement("button");a.className="game-closeButton",a.innerHTML="X",a.onclick=function(){t.removeChild(s)};var i=document.createElement("ul");this.roomsList.forEach(function(a){var n=document.createElement("li"),l=document.createElement("span");l.innerHTML=a.name+" | Players: "+a.players;var r=document.createElement("button");r.innerHTML="Join",r.onclick=function(){e.joinRoom(a.name),t.removeChild(s)}.bind(a),n.appendChild(l),n.appendChild(r),i.appendChild(n)}),s.appendChild(a),s.appendChild(i),t.appendChild(s)}},{key:"createMenu",value:function(){var e=this,t=document.getElementById("app"),s=document.createElement("div");s.className="game-menu",this.leaveB=document.createElement("button"),this.leaveB.style.display="none";var a=document.createElement("img");a.src="textures/icons/back.png";var i=document.createElement("button"),n=document.createElement("img");n.src="textures/icons/rooms.png",this.leaveB.onclick=function(){e.leaveRoom()},i.onclick=function(){e.socket.emit("rooms list")},this.leaveB.appendChild(a),i.appendChild(n),s.appendChild(this.leaveB),s.appendChild(i),t.appendChild(s)}},{key:"createInfoSpans",value:function(){var e=document.getElementById("app");this.fpsSpan=document.createElement("span"),this.fpsSpan.style="position: absolute; right: 0; color: #ffffff; z-index: 1;",this.fpsSpan.innerHTML="fps: 0",e.appendChild(this.fpsSpan),this.playersSpan=document.createElement("span"),this.playersSpan.style="position: absolute; right: 0; color: #ffffff; z-index: 1; top: "+this.fpsSpan.clientHeight+"px;",this.playersSpan.innerHTML="online: 0",e.appendChild(this.playersSpan)}},{key:"createChatPanel",value:function(){var e=document.getElementById("app"),t=document.createElement("div");t.className="game-chat";var s=document.createElement("div");s.className="game-chatMessagesContainer";var a=document.createElement("div");a.className="game-chatResize";var i=document.createElement("button");i.className="game-hideChatButton",i.innerHTML="<",t.appendChild(s),e.appendChild(t),e.appendChild(a),e.appendChild(i);var n=document.getElementsByClassName("game-menu")[0],l=document.createElement("div");l.className="game-chatInput",this.chatInput=document.createElement("input"),this.chatInput.type="text",this.chatInput.maxlength=this.maxMsgLength,l.appendChild(this.chatInput),n.appendChild(l)}},{key:"bindChatEvents",value:function(){var e=this;this.chatInput.onkeypress=function(t){var s=e.chatInput.value.trim();if(s.length>=e.maxMsgLength&&46!==t.keyCode&&8!==t.keyCode&&13!==t.keyCode)t.preventDefault();else if(13===t.keyCode&&""!==s){e.chatInput.value="";var a={type:"text",text:s=s.slice(0,e.maxMsgLength)};e.socket.emit("chat message",a),a.player=e.player.name,e.addChatMessage(a)}};var t=document.getElementsByClassName("game-hideChatButton")[0],s=document.getElementsByClassName("game-chat")[0],a=document.getElementsByClassName("game-chatResize")[0];t.onclick=function(){s.style.transition="0.5s",t.style.transition="0.5s";var e=s.getBoundingClientRect();e.left<0?(t.innerHTML="<",s.style.left="0",t.style.left=e.width+"px",a.style.display="block"):(t.innerHTML=">",s.style.left=-e.width+"px",t.style.left="0",a.style.display="none")}}},{key:"addChatMessage",value:function(e){var t=document.createElement("div");t.className="game-chatMessageC";var s=document.createElement("div");s.className="game-chatMessage";var a=document.createElement("span");a.className="game-boldText",a.textContent=e.player+": ";for(var i=document.createElement("span"),n=new RegExp("(https?://[^<>\\s]+)","gi"),l=n.exec(e.text),r=0;null!==l;){if(l.index>r){var h=document.createTextNode(e.text.substring(r,l.index));i.appendChild(h)}r=n.lastIndex;var o=document.createElement("a"),m=document.createTextNode(l[0]);o.appendChild(m),o.setAttribute("href",l[0]),o.setAttribute("target","_blank"),i.appendChild(o),l=n.exec(e.text)}if(e.text.length>r){var c=document.createTextNode(e.text.substring(r,e.text.length));i.appendChild(c)}s.appendChild(a),s.appendChild(i),t.appendChild(s);var d=document.getElementsByClassName("game-chatMessagesContainer")[0];d.appendChild(t),d.scrollTop=d.scrollHeight,e.html=t.cloneNode(!0),this.canvasChat.add(e)}},{key:"addChatInfoMessage",value:function(e){var t=document.createElement("div");t.className="game-chatMessageC";var s=document.createElement("div");s.className="game-chatMessage game-chatInfoMessage game-boldText",s.textContent=e,t.appendChild(s);var a=document.getElementsByClassName("game-chatMessagesContainer")[0];a.appendChild(t),a.scrollTop=a.scrollHeight}},{key:"getPlayerName",value:function(){var e=this,t=document.getElementById("app"),s=document.createElement("div");s.className="game-login";var a=document.createElement("div"),i=document.createElement("input");i.type="text",i.placeholder="Nickname",i.onkeydown=function(t){i.value.trim().length>=e.maxNickLength&&46!==t.keyCode&&8!==t.keyCode&&13!==t.keyCode&&t.preventDefault()};var n=document.createElement("div"),l=document.createElement("button");l.innerHTML="<span>PLAY</span>",l.onclick=function(){var t=i.value.trim();""!==t&&e.socket.emit("check name",t)},s.onkeydown=function(e){13===e.keyCode&&l.onclick()},a.appendChild(i),n.appendChild(l),s.appendChild(a),s.appendChild(n),t.appendChild(s),i.focus()}}]),e}(),Grid={size:40,originX:0,originY:0,tileW:65,tileL:39,dx:32,dy:16,drawOrdered:[],drawPos:[],setOrigin:function(e,t){this.originX=e-this.dx,this.originY=t},center:function(e,t){var s=(2*this.size-1)*this.dy;this.originX=e/2-this.dx,this.originY=(t-s)/2},move:function(e){this.originX+=e.x,this.originY+=e.y},getDrawOrdered:function(){return this.drawOrdered},cellAt:function(e,t){var s=!0,a=!1,i=void 0;try{for(var n,l=this.drawOrdered[Symbol.iterator]();!(s=(n=l.next()).done);s=!0){var r=n.value,h=e-(r.drawPos.x+this.dx),o=t-(r.drawPos.y+this.dy);if(Math.abs(h)/this.dx+Math.abs(o)/this.dy<=1)return{x:r.x,y:r.y}}}catch(e){a=!0,i=e}finally{try{!s&&l.return&&l.return()}finally{if(a)throw i}}return null},createDrawOrder:function(){this.drawOrdered=[],this.drawPos=[];for(var e=0;e<this.size;++e){this.drawPos.push([]);for(var t=0;t<this.size;++t)this.drawPos[e].push({})}for(var s=this.originX,a=void 0,i=this.originY,n=void 0,l=void 0,r=0;r<2*this.size-1;++r){for(r<this.size?(n=0,l=this.size-1-r,a=s-r*this.dx):(n=r-this.size+1,l=0,a=s-(2*this.size-r-2)*this.dx);n<this.size&&l<this.size;){var h={x:l,y:n,drawPos:{x:a,y:i}};this.drawOrdered.push(h),this.drawPos[n][l]=h.drawPos,++n,++l,a+=this.tileW}i+=this.dy}}},_createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}(),params={};params.velocity=1.3,params.framesPerImgWalk=6,params.adjustY=-69,params.X=[0,1,1,1,0,-1,-1,-1],params.Y=[-1,-1,0,1,1,1,0,-1];var Player=function(){function e(t){_classCallCheck(this,e),this.name=t.name,this.room=t.room||null,this.pos=t.pos||null,this.status="out",this.direction=t.direction||-1,this.animFrame=-1,this.walkd={x:0,y:0},this.images=[],this.client=t.client||!1,this.target=t.target||null,this.nextPos=t.nextPos||null,this.click=null}return _createClass(e,[{key:"update",value:function(e,t){this.direction===e.direction&&this.status===e.status||this.changeAnim(e.direction,e.status),null===t||null===this.pos||this.pos.x===e.pos.x&&this.pos.y===e.pos.y||(t.updatePlayerCell(this.pos,e.pos,this.name),this.walkd={x:0,y:0}),this.pos=e.pos,this.target=e.target,this.nextPos=e.nextPos}},{key:"reset",value:function(){this.room=null,this.pos=null,this.status="out",this.direction=-1,this.animFrame=-1,this.walkd={x:0,y:0},this.images=[],this.target=null,this.nextPos=null,this.click=null}},{key:"changeAnim",value:function(e,t){this.direction=e,this.status=t,this.animFrame=-1,this.walkd={x:0,y:0},this.client&&this.fetchImages()}},{key:"fetchImages",value:function(){var e="sam"+this.direction+this.status;this.images=Assets.getImgArray(e)}},{key:"getPosDirection",value:function(e,t){var s={x:e.x-t.x,y:e.y-t.y};return 0===s.x&&0===s.y?this.direction:0===s.x&&s.y>0?0:s.x<0&&s.y>0?1:s.x<0&&0===s.y?2:s.x<0&&s.y<0?3:0===s.x&&s.y<0?4:s.x>0&&s.y<0?5:s.x>0&&0===s.y?6:7}},{key:"changeDirection",value:function(e){if("stand"===this.status){var t=this.getPosDirection(this.pos,e);this.direction=t,this.client&&this.fetchImages()}}},{key:"move",value:function(e,t){for(var s=params.X,a=params.Y,i=this.pos,n=t.size,l=[],r=0;r<n;++r){l.push([]);for(var h=0;h<n;++h)l[r].push({x:-1,y:-1})}l[i.y][i.x]={x:e.x,y:e.y};for(var o=[i];o.length>0;){var m=o[0];if(o.splice(0,1),m.x===e.x&&m.y===e.y)break;for(var c=this.getPosDirection(m,e),d=0;d<8;++d){var u=(c+d)%8,p={x:m.x+s[u],y:m.y+a[u]};if(!(p.x<0||p.x>=n||p.y<0||p.y>=n)&&!(l[p.y][p.x].x>=0)){var g=t.cell(p.x,p.y);null!==g&&(g.players.length>0||(l[p.y][p.x]=m,o.push(p)))}}}if(-1!==l[e.y][e.x].x){for(var y=l[e.y][e.x],v=e;y.x!==i.x||y.y!==i.y;)v=l[v.y][v.x],y=l[y.y][y.x];var f=this.getPosDirection(i,v),x={pos:this.pos,target:e,nextPos:v,direction:f,status:"walk"};this.update(x,t)}}},{key:"stop",value:function(){this.target=null,this.nextPos=null,this.changeAnim(this.direction,"stand")}},{key:"updateLogic",value:function(e){"stand"===this.status?this.updateLogicStand(e):"walk"===this.status&&this.updateLogicWalk(e)}},{key:"updateLogicStand",value:function(e){if(null!==this.click){var t=e.cell(this.click.x,this.click.y);null!==t&&(t.players.length>0?this.changeDirection(t.pos):this.move(t.pos,e)),this.click=null}++this.animFrame,246===this.animFrame&&(this.animFrame=0)}},{key:"updateLogicWalk",value:function(e){var t=[.5,1,.5,2,.5,1,.5,2];if(this.walkd.x+=t[this.direction]*[-2,0,2,1,2,0,-2,-1][this.direction]*params.velocity,this.walkd.y+=t[this.direction]*[-1,-1,-1,0,1,1,1,0][this.direction]*params.velocity,Math.abs(this.walkd.x/64)+Math.abs(this.walkd.y/32)>1){this.walkd.x=0,this.walkd.y=0,e.updatePlayerCell(this.pos,this.nextPos,this.name),this.pos=this.nextPos;var s=!1;if(null!==this.click){var a=e.cell(this.click.x,this.click.y);null!==a&&0===a.players.length&&(this.move(a.pos,e),s=!0),this.click=null}s||(this.nextPos.x===this.target.x&&this.nextPos.y===this.target.y||e.cell(this.target.x,this.target.y).players.length>0?this.stop():this.move(this.target,e))}++this.animFrame,this.animFrame===this.images.length*params.framesPerImgWalk&&(this.animFrame=0)}},{key:"draw",value:function(e,t){switch(this.status){case"stand":this.drawStand(e,t);break;case"walk":this.drawWalk(e,t)}}},{key:"drawStand",value:function(e,t){var s=Assets.getImage("shadow");e.drawImage(s,parseInt(t.x),parseInt(t.y-6)),1===this.images.length?e.drawImage(this.images[0],parseInt(t.x),parseInt(t.y+params.adjustY)):this.animFrame<240?e.drawImage(this.images[0],parseInt(t.x),parseInt(t.y+params.adjustY)):e.drawImage(this.images[1],parseInt(t.x),parseInt(t.y+params.adjustY))}},{key:"drawWalk",value:function(e,t){var s=Assets.getImage("shadow");e.drawImage(s,parseInt(t.x+this.walkd.x),parseInt(t.y-6+this.walkd.y));var a=this.images[parseInt(this.animFrame/params.framesPerImgWalk)];e.drawImage(a,parseInt(t.x+this.walkd.x),parseInt(t.y+params.adjustY+this.walkd.y))}}]),e}();"undefined"!=typeof module&&(module.exports=Player);var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}(),Room=function(){function e(t){_classCallCheck(this,e),this.name=t.name||"New Room",this.size=t.size||10,this.array=t.array||[],this.spawn=t.spawn||{x:0,y:0},this.spawnDirection=t.spawnDirection||4,this.players=t.players||{},this.client=t.client||!1}return _createClass(e,[{key:"update",value:function(e){var t={};for(var s in e.players){var a=void 0;(a=void 0===this.players[s]?new Player(e.players[s]):this.players[s]).client=!0,a.update(e.players[s],this),a.room=this.name,t[s]=a}this.players=t,this.name=e.name,this.size=e.size,this.array=e.array,this.spawn=e.spawn}},{key:"setPlayersRoom",value:function(){for(var e in this.players)this.players[e].room=this.name}},{key:"cell",value:function(e,t){var s=this.array[t][e];return null!==s&&(s.pos={x:e,y:t}),s}},{key:"join",value:function(e){this.players[e.name]=e,e.room=this.name,e.pos=this.spawn,e.changeAnim(this.spawnDirection,"stand");var t=this.array[this.spawn.y][this.spawn.x];t.players.push(e.name),this.array[this.spawn.y][this.spawn.x]=t}},{key:"leave",value:function(e){var t=this.players[e],s=this.array[t.pos.y][t.pos.x],a=s.players.indexOf(e);s.players.splice(a,1),this.array[t.pos.y][t.pos.x]=s,this.players[e].reset(),delete this.players[e]}},{key:"clear",value:function(){for(var e in this.players)this.leave(e)}},{key:"updatePlayerCell",value:function(e,t,s){var a=this.array[e.y][e.x],i=a.players.indexOf(s);a.players.splice(i,1),(a=this.array[t.y][t.x]).players.push(s)}},{key:"updateLogic",value:function(){for(var e in this.players)this.players[e].updateLogic(this)}},{key:"draw",value:function(e){var t=Grid.getDrawOrdered(),s=!0,a=!1,i=void 0;try{for(var n,l=t[Symbol.iterator]();!(s=(n=l.next()).done);s=!0){var r=n.value,h=this.array[r.y][r.x];if(null!==h){var o=Assets.getImage(h.material);e.drawImage(o,parseInt(r.drawPos.x),parseInt(r.drawPos.y))}}}catch(e){a=!0,i=e}finally{try{!s&&l.return&&l.return()}finally{if(a)throw i}}var m=!0,c=!1,d=void 0;try{for(var u,p=t[Symbol.iterator]();!(m=(u=p.next()).done);m=!0){var g=u.value,y=this.array[g.y][g.x];if(null!==y&&y.players.length>0){var v=!0,f=!1,x=void 0;try{for(var k,w=y.players[Symbol.iterator]();!(v=(k=w.next()).done);v=!0){var C=k.value;this.players[C].draw(e,g.drawPos)}}catch(e){f=!0,x=e}finally{try{!v&&w.return&&w.return()}finally{if(f)throw x}}}}}catch(e){c=!0,d=e}finally{try{!m&&p.return&&p.return()}finally{if(c)throw d}}}}]),e}();"undefined"!=typeof module&&(module.exports=Room);