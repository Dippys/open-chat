"use strict";var Assets={images:{},imgLoaded:0,imgFiles:[],load:function e(){this.fillFileArrays();this.loadImages()},loadImages:function e(){var t=this;var i=new Image;i.src=this.imgFiles[this.imgLoaded];i.onload=function(){var e=i.src.split("/");var s=e[e.length-1].split(".")[0];t.images[s]=i;++t.imgLoaded;if(t.imgLoaded<t.imgFiles.length){t.loadImages()}else{game.startGame()}}},getImage:function e(t){return this.images[t]},getImgArray:function e(t){var i=[];for(var s in this.images){if(s.indexOf(t)===0)i.push(this.images[s])}return i},fillFileArrays:function e(){var t="./textures/floor/";this.imgFiles.push(t+"grass.png");t="./textures/character/";this.imgFiles.push(t+"sam0stand.png");this.imgFiles.push(t+"sam0walk-1.png");this.imgFiles.push(t+"sam0walk-2.png");this.imgFiles.push(t+"sam0walk-3.png");this.imgFiles.push(t+"sam0walk-4.png");this.imgFiles.push(t+"sam1stand.png");this.imgFiles.push(t+"sam1walk-1.png");this.imgFiles.push(t+"sam1walk-2.png");this.imgFiles.push(t+"sam1walk-3.png");this.imgFiles.push(t+"sam1walk-4.png");this.imgFiles.push(t+"sam2stand.png");this.imgFiles.push(t+"sam2walk-1.png");this.imgFiles.push(t+"sam2walk-2.png");this.imgFiles.push(t+"sam2walk-3.png");this.imgFiles.push(t+"sam2walk-4.png");this.imgFiles.push(t+"sam3stand-1.png");this.imgFiles.push(t+"sam3stand-2.png");this.imgFiles.push(t+"sam3walk-1.png");this.imgFiles.push(t+"sam3walk-2.png");this.imgFiles.push(t+"sam3walk-3.png");this.imgFiles.push(t+"sam3walk-4.png");this.imgFiles.push(t+"sam4stand-1.png");this.imgFiles.push(t+"sam4stand-2.png");this.imgFiles.push(t+"sam4walk-1.png");this.imgFiles.push(t+"sam4walk-2.png");this.imgFiles.push(t+"sam4walk-3.png");this.imgFiles.push(t+"sam4walk-4.png");this.imgFiles.push(t+"sam5stand-1.png");this.imgFiles.push(t+"sam5stand-2.png");this.imgFiles.push(t+"sam5walk-1.png");this.imgFiles.push(t+"sam5walk-2.png");this.imgFiles.push(t+"sam5walk-3.png");this.imgFiles.push(t+"sam6stand-1.png");this.imgFiles.push(t+"sam6stand-2.png");this.imgFiles.push(t+"sam6walk-1.png");this.imgFiles.push(t+"sam6walk-2.png");this.imgFiles.push(t+"sam6walk-3.png");this.imgFiles.push(t+"sam6walk-4.png");this.imgFiles.push(t+"sam7stand-1.png");this.imgFiles.push(t+"sam7stand-2.png");this.imgFiles.push(t+"sam7walk-1.png");this.imgFiles.push(t+"sam7walk-2.png");this.imgFiles.push(t+"sam7walk-3.png");this.imgFiles.push(t+"sam7walk-4.png");this.imgFiles.push(t+"shadow.png")}};"use strict";var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||false;s.configurable=true;if("value"in s)s.writable=true;Object.defineProperty(e,s.key,s)}}return function(t,i,s){if(i)e(t.prototype,i);if(s)e(t,s);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var Game=function(){function e(){_classCallCheck(this,e);console.log("Initializing Game...");this.socket=null;this.playerName=null;this.player=null;this.room=null;this.canvasCtx=null;this.lastFrameTimeMs=0;this.d={x:0,y:0};this.initialPos={x:0,y:0};this.mouse=null;this.mousedown=false;this.click=null;this.disableClick=false;this.getPlayerName()}_createClass(e,[{key:"init",value:function e(){this.createChatPanel();this.socket=io();this.configureSocket();this.bindChatEvents();this.createCanvas();this.bindEvents();this.configGrid();Assets.load()}},{key:"configGrid",value:function e(){}},{key:"startGame",value:function e(){this.socket.emit("join room",this.roomsList[0]);requestAnimationFrame(this.gameLoop.bind(this))}},{key:"gameLoop",value:function e(t){var i=1e3/(t-this.lastFrameTimeMs);this.fpsSpan.innerHTML="fps: "+Math.ceil(i);this.lastFrameTimeMs=t;this.update();this.draw();requestAnimationFrame(this.gameLoop.bind(this))}},{key:"update",value:function e(){if(this.room!==null){this.room.updateLogic()}this.d={x:0,y:0};if(this.mouse!==null){this.d.x+=this.mouse.clientX-this.initialPos.x;this.d.y+=this.mouse.clientY-this.initialPos.y;Grid.move(this.d);Grid.createDrawOrder();this.initialPos.x=this.mouse.clientX;this.initialPos.y=this.mouse.clientY;this.mouse=null}}},{key:"draw",value:function e(){var t=this.canvasCtx;t.fillStyle="#010101";t.fillRect(0,0,t.canvas.width,t.canvas.height);if(this.room!==null){this.room.draw(t)}}},{key:"bindEvents",value:function e(){var t=this;var i=document.getElementsByClassName("game-canvas")[0];var s=document.getElementsByTagName("body")[0];s.onresize=function(){i.height=i.clientHeight;i.width=i.clientWidth;Grid.center(i.width,i.height);Grid.createDrawOrder()};i.onmousedown=function(e){t.mousedown=true;t.initialPos.x=e.clientX;t.initialPos.y=e.clientY};document.onmousemove=function(e){if(t.mousedown){t.mouse=e;t.disableClick=true}};document.onmouseup=function(e){t.mousedown=false};i.onclick=function(e){if(!t.disableClick)t.click=e;t.disableClick=false}}},{key:"createCanvas",value:function e(){var t=document.getElementById("app");var i=document.createElement("canvas");i.className="game-canvas";this.canvasCtx=i.getContext("2d");t.appendChild(i);i.height=i.clientHeight;i.width=i.clientWidth;this.fpsSpan=document.createElement("span");this.fpsSpan.style="position: absolute; right: 0; color: #ffffff;";this.fpsSpan.innerHTML="XX";t.appendChild(this.fpsSpan);this.playersSpan=document.createElement("span");this.playersSpan.style="position: absolute; right: 0; color: #ffffff;"+" top: "+this.fpsSpan.clientHeight+"px;";this.playersSpan.innerHTML="YY";t.appendChild(this.playersSpan)}},{key:"configureSocket",value:function e(){var t=this;this.socket.emit("new player",this.playerName);this.socket.on("chat message",function(e){t.addChatMessage(e.player,e.msg)});this.socket.on("rooms list",function(e){t.roomsList=e});this.socket.on("room info",function(e){if(t.room===null){t.room=new Room({a:0});t.room.update(e);t.player=t.room.getPlayer(t.playerName);t.player.setSocket(t.socket);Grid.setSize(t.room.getSize());Grid.center(t.canvasCtx.canvas.width,t.canvasCtx.canvas.height);Grid.createDrawOrder()}else t.room.update(e)});this.socket.on("online players",function(e){t.playersSpan.innerHTML="online: "+e})}},{key:"createChatPanel",value:function e(){var t=document.getElementById("app");var i=document.createElement("div");i.className="game-chat";var s=document.createElement("div");s.className="game-chatMessagesContainer";var a=document.createElement("div");a.className="game-chatInput";this.chatInput=document.createElement("input");this.chatInput.type="text";a.appendChild(this.chatInput);i.appendChild(s);i.appendChild(a);t.appendChild(i)}},{key:"bindChatEvents",value:function e(){var t=this;this.chatInput.onkeypress=function(e){var i=t.chatInput.value.trim();if(e.keyCode===13&&i!==""){t.chatInput.value="";t.socket.emit("chat message",i);t.addChatMessage(t.playerName,i)}}}},{key:"addChatMessage",value:function e(t,i){var s=document.createElement("div");s.className="game-chatMessage";var a=document.createElement("span");var n=document.createElement("span");n.className="game-boldText";n.textContent=t+": ";var r=document.createTextNode(i);a.appendChild(n);a.appendChild(r);s.appendChild(a);var l=document.getElementsByClassName("game-chatMessagesContainer")[0];l.appendChild(s);l.scrollTop=l.scrollHeight}},{key:"getPlayerName",value:function e(){var t=this;var i=document.getElementById("app");var s=document.createElement("div");s.className="game-centered";var a=document.createElement("div");a.className="game-horizontalLayout";var n=document.createElement("div");n.className="game-horizontalLayout";var r=document.createElement("span");r.className="game-label";r.innerHTML="Nickname:";var l=document.createElement("div");l.className="game-horizontalLayout";var h=document.createElement("input");h.type="text";var o=document.createElement("div");o.className="game-horizontalLayout";var u=document.createElement("button");u.className="game-horizontalCentered";u.innerHTML="Play";u.onclick=function(){var e=h.value.trim();if(e!==""){t.playerName=e;i.innerHTML="";t.init()}};s.onkeydown=function(e){if(e.keyCode===13){u.onclick()}};n.appendChild(r);l.appendChild(h);a.appendChild(n);a.appendChild(l);o.appendChild(u);s.appendChild(a);s.appendChild(o);i.appendChild(s);h.focus()}}]);return e}();"use strict";var Grid={size:40,originX:0,originY:0,tileW:65,tileL:39,dx:32,dy:16,drawOrdered:[],X:[0,1,1,1,0,-1,-1,-1],Y:[-1,-1,0,1,1,1,0,-1],setSize:function e(t){this.size=t},setOrigin:function e(t,i){this.originX=t-this.dx;this.originY=i},center:function e(t,i){var s=2*this.size-1;var a=s*this.dy;this.originX=t/2-this.dx;this.originY=(i-a)/2},move:function e(t){this.originX+=t.x;this.originY+=t.y},getDrawOrdered:function e(){return this.drawOrdered},cellAt:function e(t,i){var s=true;var a=false;var n=undefined;try{for(var r=this.drawOrdered[Symbol.iterator](),l;!(s=(l=r.next()).done);s=true){var h=l.value;var o=h.drawPos.x+this.dx;var u=h.drawPos.y+this.dy;var c=t-o;var m=i-u;var d=Math.abs(c)/this.dx+Math.abs(m)/this.dy;if(d<=1)return{x:h.x,y:h.y}}}catch(e){a=true;n=e}finally{try{if(!s&&r.return){r.return()}}finally{if(a){throw n}}}return null},createDrawOrder:function e(){this.drawOrdered=[];var t=this.originX;var i=this.originY;var s=void 0;var a=i;var n=void 0;var r=void 0;for(var l=0;l<2*this.size-1;++l){if(l<this.size){n=0;r=this.size-1-l;s=t-l*this.dx}else{n=l-this.size+1;r=0;s=t-(2*this.size-l-2)*this.dx}while(n<this.size&&r<this.size){var h={x:r,y:n,drawPos:{x:s,y:a}};this.drawOrdered.push(h);++n;++r;s+=this.tileW}a+=this.dy}}};"use strict";var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||false;s.configurable=true;if("value"in s)s.writable=true;Object.defineProperty(e,s.key,s)}}return function(t,i,s){if(i)e(t.prototype,i);if(s)e(t,s);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var Player=function(){function e(t){_classCallCheck(this,e);this.name=t.name;this.room=t.room||null;this.pos=t.pos||null;this.adjustY=-69;this.character="sam";this.status="out";this.direction=t.direction||-1;this.animFrame=0;this.images=[];this.walkd={x:0,y:0};this.target=t.target||null;this.nextPos=t.nextPos||null;this.socket=null}_createClass(e,[{key:"update",value:function e(t){if(this.direction!==t.direction||this.status!==t.status){this.setDirAndStatus(t.direction,t.status)}this.pos=t.pos;this.target=t.target;this.nextPos=t.nextPos}},{key:"setRoom",value:function e(t){this.room=t}},{key:"setPos",value:function e(t){this.pos=t}},{key:"setSocket",value:function e(t){this.socket=t}},{key:"setDirection",value:function e(t){this.direction=t}},{key:"setStatus",value:function e(t){this.status=t}},{key:"setDirAndStatus",value:function e(t,i){this.direction=t;this.status=i;this.animFrame=0;this.walkd={x:0,y:0};this.fetchImages()}},{key:"getName",value:function e(){return this.name}},{key:"getRoom",value:function e(){return this.room}},{key:"getPos",value:function e(){return this.pos}},{key:"getStatus",value:function e(){return this.status}},{key:"getDirection",value:function e(){return this.direction}},{key:"fetchImages",value:function e(){var t=this.character+this.direction+this.status;this.images=Assets.getImgArray(t)}},{key:"getPosDirection",value:function e(t,i){var s={x:t.x-i.x,y:t.y-i.y};if(s.x===0&&s.y>0)return 0;if(s.x<0&&s.y>0)return 1;if(s.x<0&&s.y===0)return 2;if(s.x<0&&s.y<0)return 3;if(s.x===0&&s.y<0)return 4;if(s.x>0&&s.y<0)return 5;if(s.x>0&&s.y===0)return 6;return 7}},{key:"changeDirection",value:function e(t){if(this.status==="stand"){var i=this.getPosDirection(this.pos,t);this.direction=i;this.fetchImages();this.socket.emit("change direction",i)}}},{key:"move",value:function e(t,i){var s=Grid.X;var a=Grid.Y;var n=this.pos;var r=i.getSize();var l=[];for(var h=0;h<r;++h){l.push([]);for(var o=0;o<r;++o){l[h].push({x:-1,y:-1})}}l[n.y][n.x]={x:t.x,y:t.y};var u=[n];while(u.length>0){var c=u[0];u.splice(0,1);if(c.x===t.x&&c.y===t.y)break;var m=this.getPosDirection(c,t);for(var d=0;d<8;++d){var p=(m+d)%8;var g={x:c.x+s[p],y:c.y+a[p]};if(g.x<0||g.x>=r||g.y<0||g.y>=r)continue;if(l[g.y][g.x].x>=0)continue;var f=i.cell(g.x,g.y);if(f===null)continue;if(f.players.length>0)continue;l[g.y][g.x]=c;u.push(g)}}if(l[t.y][t.x].x!==-1){var y=l[t.y][t.x];var v=t;while(y.x!==n.x||y.y!==n.y){v=l[v.y][v.x];y=l[y.y][y.x]}var k=this.getPosDirection(n,v);var w={pos:this.pos,target:t,nextPos:v,direction:k};this.socket.emit("move",w)}}},{key:"updateLogic",value:function e(t){var i=64;var s=32;if(this.status==="walk"){var a=Math.abs(this.walkd.x/i)+Math.abs(this.walkd.y/s);if(a>1){this.walkd.x=0;this.walkd.y=0;var n=t.cell(this.pos.x,this.pos.y);var r=n.players.indexOf(this.name);n.players.splice(r,1);this.pos=this.nextPos;n=t.cell(this.pos.x,this.pos.y);n.players.push(this.name);if(game.click!==null&&this.name===game.playerName){var l=Grid.cellAt(game.click.clientX,game.click.clientY);if(l!==null){var h=t.cell(l.x,l.y);if(h!==null&&h.players.length===0){this.move(l,t);game.click=null;return}}game.click=null}if(this.nextPos.x===this.target.x&&this.nextPos.y===this.target.y){this.target=null;this.nextPos=null;this.setDirAndStatus(this.direction,"stand");if(this.name===game.playerName)this.socket.emit("end-move")}else{if(this.name===game.playerName)this.move(this.target,t)}}else{var o=[-2,0,2,1,2,0,-2,-1];var u=[-1,-1,-1,0,1,1,1,0];var c=[.5,1,.5,2,.5,1,.5,2];this.walkd.x+=c[this.direction]*o[this.direction];this.walkd.y+=c[this.direction]*u[this.direction]}}else if(this.status==="stand"){if(game.click!==null&&this.name===game.playerName){var m=Grid.cellAt(game.click.clientX,game.click.clientY);if(m!==null){var d=t.cell(m.x,m.y);if(d!==null){if(d.players.length>0){this.changeDirection(m)}else{this.move(m,t)}}}game.click=null}}}},{key:"draw",value:function e(t,i){switch(this.status){case"stand":this.drawStand(t,i);break;case"walk":this.drawWalk(t,i);break}}},{key:"drawStand",value:function e(t,i){var s=Assets.getImage("shadow");t.drawImage(s,i.x,i.y-6);if(this.images.length===1){t.drawImage(this.images[0],i.x,i.y+this.adjustY)}else{if(this.animFrame<240)t.drawImage(this.images[0],i.x,i.y+this.adjustY);else t.drawImage(this.images[1],i.x,i.y+this.adjustY);++this.animFrame;if(this.animFrame===246)this.animFrame=0}}},{key:"drawWalk",value:function e(t,i){var s=Assets.getImage("shadow");t.drawImage(s,i.x+this.walkd.x,i.y-6+this.walkd.y);var a=6;var n=this.images[parseInt(this.animFrame/a)];t.drawImage(n,i.x+this.walkd.x,i.y+this.adjustY+this.walkd.y);++this.animFrame;if(this.animFrame===this.images.length*a){this.animFrame=0}}}]);return e}();if(typeof module!=="undefined"){module.exports=Player}"use strict";var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||false;s.configurable=true;if("value"in s)s.writable=true;Object.defineProperty(e,s.key,s)}}return function(t,i,s){if(i)e(t.prototype,i);if(s)e(t,s);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var Room=function(){function e(t){_classCallCheck(this,e);this.name=t.name||"New Room";this.size=t.size||10;this.array=t.array||[];this.spawn=t.spawn||{x:0,y:0};this.spawnDirection=t.spawnDirection||4;this.players=t.players||{}}_createClass(e,[{key:"update",value:function e(t){var i={};for(var s in t.players){var a=void 0;if(typeof this.players[s]==="undefined"){a=new Player(t.players[s])}else{a=this.players[s]}a.update(t.players[s]);i[s]=a}this.players=i;this.name=t.name;this.size=t.size;this.array=t.array;this.spawn=t.spawn}},{key:"cell",value:function e(t,i){return this.array[i][t]}},{key:"cellAt",value:function e(t,i){var s=Grid.cellAt(t,i);if(s===null)return s;var a=this.array[s.y][s.x];if(a!==null)a.pos=s;return a}},{key:"setName",value:function e(t){this.name=t}},{key:"setSize",value:function e(t){this.size=t}},{key:"setSpawn",value:function e(t,i){this.spawn={x:t,y:i}}},{key:"join",value:function e(t){this.players[t.getName()]=t;t.setRoom(this.name);t.setPos(this.spawn);t.setStatus("stand");t.setDirection(this.spawnDirection);var i=this.array[this.spawn.y][this.spawn.x];i.players.push(t.getName());this.array[this.spawn.y][this.spawn.x]=i}},{key:"leave",value:function e(t){var i=this.players[t];var s=this.array[i.getPos().y][i.getPos().x];var a=s.players.indexOf(t);s.players.splice(a,1);this.array[i.getPos().y][i.getPos().x]=s;this.players[t].setRoom(null);this.players[t].setPos(null);delete this.players[t]}},{key:"clear",value:function e(){for(var t in this.players){this.leave(t)}}},{key:"getName",value:function e(){return this.name}},{key:"getSize",value:function e(){return this.size}},{key:"getSpawn",value:function e(){return this.spawn}},{key:"getPlayer",value:function e(t){return this.players[t]}},{key:"getPlayers",value:function e(){return this.players}},{key:"updateLogic",value:function e(){for(var t in this.players){this.players[t].updateLogic(this)}}},{key:"draw",value:function e(t){var i=Grid.getDrawOrdered();var s=true;var a=false;var n=undefined;try{for(var r=i[Symbol.iterator](),l;!(s=(l=r.next()).done);s=true){var h=l.value;var o=this.array[h.y][h.x];if(o!==null){var u=Assets.getImage(o.material);t.drawImage(u,h.drawPos.x,h.drawPos.y)}}}catch(e){a=true;n=e}finally{try{if(!s&&r.return){r.return()}}finally{if(a){throw n}}}var c=true;var m=false;var d=undefined;try{for(var p=i[Symbol.iterator](),g;!(c=(g=p.next()).done);c=true){var f=g.value;var y=this.array[f.y][f.x];if(y!==null&&y.players.length>0){var v=true;var k=false;var w=undefined;try{for(var x=y.players[Symbol.iterator](),C;!(v=(C=x.next()).done);v=true){var F=C.value;this.players[F].draw(t,f.drawPos)}}catch(e){k=true;w=e}finally{try{if(!v&&x.return){x.return()}}finally{if(k){throw w}}}}}}catch(e){m=true;d=e}finally{try{if(!c&&p.return){p.return()}}finally{if(m){throw d}}}}}]);return e}();if(typeof module!=="undefined"){module.exports=Room}