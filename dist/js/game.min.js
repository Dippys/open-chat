"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Assets={images:{},imgLoaded:0,imgFiles:[],avatars:{},load:function(){this.fillFileArrays(),this.loadImages()},loadImages:function(){var e=this,t=new Image;t.src=this.imgFiles[this.imgLoaded],t.onload=function(){var a=t.src.split("/"),i=a[a.length-1].split(".")[0];e.images[i]=t,++e.imgLoaded,e.imgLoaded<e.imgFiles.length?e.loadImages():e.loadAvatarImages("defaultAvatar",!0,null)}},getImage:function(e){return this.images[e]},getImgArray:function(e,t,a){return this.avatars[e][t][a]},fillFileArrays:function(){var e="./textures/floor/";this.imgFiles.push(e+"grass.png"),this.imgFiles.push(e+"default.png"),e="./textures/misc/",this.imgFiles.push(e+"shadow.png")},loadAvatarImages:function(e,t,a){var i=this;this.avatars[e]={num_loaded:0};var n=this.createAvatarFilesObject(e);for(var s in n){this.avatars[e][s]=[];var r=0,o=!0,l=!1,h=void 0;try{for(var d,c=n[s][Symbol.iterator]();!(o=(d=c.next()).done);o=!0){var m=d.value;this.avatars[e][s].push([]);var u=!0,p=!1,g=void 0;try{for(var y,v=m[Symbol.iterator]();!(u=(y=v.next()).done);u=!0){var f=y.value,w=new Image;w.src=f,w.onload=function(){i.avatars[e].num_loaded++,45===i.avatars[e].num_loaded&&(null!==a&&(a.images=i.avatars[e]),t&&game.startGame())},w.onerror=function(){delete i.avatars[e]},this.avatars[e][s][r].push(w)}}catch(e){p=!0,g=e}finally{try{!u&&v.return&&v.return()}finally{if(p)throw g}}r++}}catch(e){l=!0,h=e}finally{try{!o&&c.return&&c.return()}finally{if(l)throw h}}}},createAvatarFilesObject:function(e){var t={};t.stand=[["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=6&head_direction=6"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=7&head_direction=7"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=0&head_direction=0"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=1&head_direction=1","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=1&head_direction=1&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=2&head_direction=2","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=2&head_direction=2&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=3&head_direction=3","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=3&head_direction=3&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=4&head_direction=4","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=4&head_direction=4&gesture=eyb"],["https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=5&head_direction=5","https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction=5&head_direction=5&gesture=eyb"]],t.walk=[];for(var a=6,i=0;i<8;++i){t.walk.push([]);for(var n=0;n<4;++n){var s="https://www.habbo.es/habbo-imaging/avatarimage?hb=image&user="+e+"&direction="+a+"&head_direction="+a+"&action=wlk&frame="+n;t.walk[i].push(s)}a=(a+1)%8}return t}},CanvasChat={init:function(){this.players={},this.msgs=[],this.vel=1.5,this.t=-1,this.adjustX=32,this.moveUp=23,this.maxW=345;var e=document.getElementById("app");this.chat=document.createElement("div"),this.chat.style.width=e.clientWidth+"px",this.chat.style.height=e.clientHeight+"px",this.defaultY=e.clientHeight/3,this.chat.id="canvasChat",this.chat.style.position="absolute",this.chat.style.zIndex="1",this.chat.style.pointerEvents="none",e.appendChild(this.chat)},add:function(e){e.html.style.position="fixed";var t=e.html.getElementsByClassName("game-chatMessage")[0];t.className="game-chatMessage game-canvasChatMessage",t.style.maxWidth=this.maxW-18+"px",this.chat.appendChild(e.html);var a=e.html.getBoundingClientRect();e.width=a.width,e.height=a.height,e.dy=-e.height,e.dx=this.adjustX-e.width/2,e.pos=this.players[e.player].pos,delete e.player,delete e.text,this.msgs.length>0&&(this.move(e,-1),this.clean()),this.msgs.push(e)},touch:function(e,t){var a=Grid.drawPos[e.pos.y][e.pos.x],i=Grid.drawPos[t.pos.y][t.pos.x];if(a={x:a.x+e.dx,y:e.dy},(i={x:i.x+t.dx,y:t.dy}).y<a.y&&i.y+t.height>a.y||i.y<a.y+e.height&&i.y+t.height>=a.y+e.height||i.y>=a.y&&i.y+t.height<=a.y+e.height){if(a.x<i.x&&a.x+e.width>i.x)return!0;if(a.x<i.x+t.width&&a.x+e.width>i.x+t.width)return!0;if(a.x>=i.x&&a.x+e.width<=i.x+t.width)return!0}return!1},move:function(e,t){for(var a=0;a<this.msgs.length;++a)if(a!==t&&this.touch(e,this.msgs[a])){var i=this.msgs[a];i.dy,i.height,e.dy,e.height;this.msgs[a].dy=e.dy-this.msgs[a].height,this.move(this.msgs[a],a)}},clean:function(){for(var e=0;e<this.msgs.length;++e)this.msgs[e].dy+this.msgs[e].height<=-this.defaultY&&(this.chat.removeChild(this.msgs[e].html),this.msgs.splice(e,1),--e)},update:function(){if(++this.t,this.t>=360/this.vel){var e=!0,t=!1,a=void 0;try{for(var i,n=this.msgs[Symbol.iterator]();!(e=(i=n.next()).done);e=!0)i.value.dy-=this.moveUp}catch(e){t=!0,a=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw a}}this.t=0,this.clean()}},draw:function(){if(this.msgs.length>0){var e=!0,t=!1,a=void 0;try{for(var i,n=this.msgs[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var s=i.value,r=Grid.drawPos[s.pos.y][s.pos.x];s.html.style.left=r.x+s.dx+"px",s.html.style.top=this.defaultY+s.dy+"px"}}catch(e){t=!0,a=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw a}}}},clear:function(){this.msgs=[],this.chat.innerHTML=""}},Chat={socket:null,playerName:null,maxMsgLength:136,minChatWidth:150,maxFileSize:314572800,allowedTypes:["image","video","audio"],init:function(){WavRecorder.init()},create:function(){this.createChatPanel(),this.bindChatEvents()},remove:function(){var e=document.getElementById("app"),t=document.getElementsByClassName("game-chat")[0],a=document.getElementsByClassName("game-chatResize")[0],i=document.getElementsByClassName("game-hideChatButton")[0],n=document.getElementsByClassName("game-menu")[0],s=document.getElementsByClassName("game-chatInput")[0];e.removeChild(t),e.removeChild(a),e.removeChild(i),n.removeChild(s)},createChatPanel:function(){var e=document.getElementById("app"),t=document.createElement("div");t.className="game-chat";var a=document.createElement("div");a.className="game-chatMessagesContainer";var i=document.createElement("div");i.className="game-chatResize";var n=document.createElement("button");n.className="game-hideChatButton",n.innerHTML="<",t.appendChild(a),e.appendChild(t),e.appendChild(i),e.appendChild(n);var s=document.getElementsByClassName("game-menu")[0];this.micB=document.createElement("button"),this.micB.className="game-mic",WavRecorder.available||(this.micB.className+=" game-disabled",this.micB.setAttribute("disabled",""));var r=document.createElement("img");r.src="textures/icons/mic.png",this.micB.appendChild(r);var o=document.createElement("div");o.className="game-chatInput",this.chatInput=document.createElement("input"),this.chatInput.type="text",this.chatInput.maxlength=this.maxMsgLength,o.appendChild(this.micB),o.appendChild(this.chatInput),s.appendChild(o)},bindChatEvents:function(){var e=this;this.chatInput.onkeypress=function(t){var a=e.chatInput.value.trim();if(a.length>=e.maxMsgLength&&46!==t.keyCode&&8!==t.keyCode&&13!==t.keyCode)t.preventDefault();else if(13===t.keyCode&&""!==a){e.chatInput.value="";var i={type:"text",text:a=a.slice(0,e.maxMsgLength)};e.socket.emit("chat message",i),i.player=e.playerName,e.addMsg(i)}},this.micB.onmousedown=function(e){WavRecorder.start()};var t=document.getElementById("app");t.onmouseup=function(t){if(WavRecorder.recording){var a=WavRecorder.stop();a.name="OpenChat-"+e.playerName+e.timeString()+".wav",e.readFile(a)}},t.onkeydown=function(e){27===e.keyCode&&WavRecorder.recording&&WavRecorder.cancel()};var a=document.getElementsByClassName("game-hideChatButton")[0],i=document.getElementsByClassName("game-chat")[0],n=document.getElementsByClassName("game-chatResize")[0];a.onclick=function(){i.style.transition="0.5s",a.style.transition="0.5s";var e=i.getBoundingClientRect();e.left<0?(a.innerHTML="<",i.style.left="0",a.style.left=e.width+"px",n.style.display="block"):(a.innerHTML=">",i.style.left=-e.width+"px",a.style.left="0",n.style.display="none")}},timeString:function(){var e=new Date,t=this.twoDigitString(e.getMonth()+1),a=this.twoDigitString(e.getDate()),i=this.twoDigitString(e.getHours()),n=this.twoDigitString(e.getMinutes()),s=this.twoDigitString(e.getSeconds());return e.getFullYear()+t+a+i+n+s},twoDigitString:function(e){return e<10&&(e="0"+e),""+e},checkAndReadFile:function(e){this.allowedFile(e)&&this.readFile(e)},readFile:function(e){var t=this,a=new FileReader;a.onload=function(a){var i=a.target.result,n={type:i.substring(5,20).split(";")[0],data:i,filename:e.name};t.socket.emit("file message",n),n.player=t.playerName,t.addFileMsg(n)},a.readAsDataURL(e)},addFileMsg:function(e){var t=e.type.split("/")[0];"image"===t?this.addImageMsg(e):"video"===t?this.addVideoMsg(e):"audio"===t&&this.addAudioMsg(e)},addImageMsg:function(e){var t=this,a=document.createElement("div");a.className="game-chatMessageC";var i=document.createElement("div");i.className="game-chatMessage";var n=document.createElement("span");n.className="game-boldText",n.style.float="left",n.textContent=e.player+":";var s=document.getElementsByClassName("game-chatMessagesContainer")[0],r=document.createElement("div"),o=new Image;o.className="game-file",this.addFullWindow(o),o.onload=function(){s.appendChild(a),s.scrollTop=s.scrollHeight,delete e.data,e.html=a.cloneNode(!0);var i=e.html.getElementsByTagName("img")[0];t.addFullWindow(i),CanvasChat.add(e)},o.src=e.data;var l=this.createFileLink(e);r.appendChild(o),r.appendChild(l),i.appendChild(n),i.appendChild(r),a.appendChild(i)},addFullWindow:function(e){e.onclick=function(){var t=document.getElementById("app"),a=document.createElement("div");a.className="game-fullWinPanel",t.appendChild(a),a.onclick=function(){t.removeChild(a)};var i=new Image;i.className="game-fullWinImg",i.src=e.src,a.appendChild(i)}},addVideoMsg:function(e){var t=document.createElement("div");t.className="game-chatMessageC";var a=document.createElement("div");a.className="game-chatMessage";var i=document.createElement("span");i.className="game-boldText",i.style.float="left",i.textContent=e.player+":";var n=document.getElementsByClassName("game-chatMessagesContainer")[0],s=void 0;if("video/mp4"===e.type){s=document.createElement("div");var r=document.createElement("video");r.setAttribute("controls",""),r.className="game-file",r.onloadeddata=function(){n.appendChild(t),n.scrollTop=n.scrollHeight},r.src=e.data;var o=r.cloneNode(!0);o.onloadeddata=function(){e.html=t.cloneNode(!0);var a=e.html.getElementsByClassName("game-chatMessage")[0].getElementsByTagName("div")[0],i=a.getElementsByTagName("video");i.length>0&&a.removeChild(i[0]),a.insertBefore(o,a.firstChild),CanvasChat.add(e)},r.load(),o.load();var l=this.createFileLink(e);s.appendChild(r),s.appendChild(l)}else s=this.createFileLink(e);a.appendChild(i),a.appendChild(s),t.appendChild(a),"video/mp4"!==e.type&&(n.appendChild(t),n.scrollTop=n.scrollHeight,e.html=t.cloneNode(!0),CanvasChat.add(e))},addAudioMsg:function(e){var t=document.createElement("div");t.className="game-chatMessageC";var a=document.createElement("div");a.className="game-chatMessage";var i=document.createElement("span");i.className="game-boldText",i.style.float="left",i.textContent=e.player+":";var n=document.getElementsByClassName("game-chatMessagesContainer")[0],s=void 0;if("audio/mpeg"===e.type||"audio/wav"===e.type||"audio/mp3"===e.type){s=document.createElement("div");var r=document.createElement("audio");r.setAttribute("controls",""),r.className="game-file",r.onloadeddata=function(){n.appendChild(t),n.scrollTop=n.scrollHeight,delete e.data,e.html=t.cloneNode(!0),CanvasChat.add(e)},r.src=e.data,r.load();var o=this.createFileLink(e);s.appendChild(r),s.appendChild(o)}else s=this.createFileLink(e);a.appendChild(i),a.appendChild(s),t.appendChild(a),"audio/mpeg"!==e.type&&"audio/wav"!==e.type&&"audio/mp3"!==e.type&&(n.appendChild(t),n.scrollTop=n.scrollHeight,e.html=t.cloneNode(!0),CanvasChat.add(e))},createFileLink:function(e){var t=document.createElement("a");t.innerHTML="Download "+e.type.split("/")[0]+" file";var a=this.dataURItoBlob(e),i=URL.createObjectURL(a);return t.setAttribute("href",i),t.setAttribute("download",e.filename),t.setAttribute("target","_blank"),t},addMsg:function(e){var t=document.createElement("div");t.className="game-chatMessageC";var a=document.createElement("div");a.className="game-chatMessage";var i=document.createElement("span");i.className="game-boldText",i.textContent=e.player+":";for(var n=document.createElement("span"),s=new RegExp("(https?://[^<>\\s]+)","gi"),r=s.exec(e.text),o=0;null!==r;){if(r.index>o){var l=document.createTextNode(e.text.substring(o,r.index));n.appendChild(l)}o=s.lastIndex;var h=document.createElement("a"),d=document.createTextNode(r[0]);h.appendChild(d),h.setAttribute("href",r[0]),h.setAttribute("target","_blank"),n.appendChild(h),r=s.exec(e.text)}if(e.text.length>o){var c=document.createTextNode(e.text.substring(o,e.text.length));n.appendChild(c)}a.appendChild(i),a.appendChild(n),t.appendChild(a);var m=document.getElementsByClassName("game-chatMessagesContainer")[0];m.appendChild(t),m.scrollTop=m.scrollHeight,e.html=t.cloneNode(!0),CanvasChat.add(e)},addInfoMsg:function(e){var t=document.createElement("div");t.className="game-chatMessageC";var a=document.createElement("div");a.className="game-chatMessage game-chatInfoMessage game-boldText",a.textContent=e,t.appendChild(a);var i=document.getElementsByClassName("game-chatMessagesContainer")[0];i.appendChild(t),i.scrollTop=i.scrollHeight},allowedFile:function(e){if(e.size>this.maxFileSize)return!1;for(var t=0;t<this.allowedTypes.length;++t)if(e.type.split("/")[0]===this.allowedTypes[t])return!0;return!1},dataURItoBlob:function(e){for(var t=atob(e.data.split(",")[1]),a=new ArrayBuffer(t.length),i=new Uint8Array(a),n=0;n<t.length;++n)i[n]=t.charCodeAt(n);return new Blob([a],{type:e.type})}},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),Game=function(){function e(){_classCallCheck(this,e),this.player=null,this.room=null,this.roomsList=null,this.maxNickLength=15,this.delta=0,this.fps=60,this.timestep=1e3/this.fps,this.lastFrameTimeMs=0,this.frame=null,this.socket=io({reconnection:!1}),this.canvasCtx=null,this.d={x:0,y:0},this.initialPos={x:0,y:0},this.mouse=null,this.mousedown=!1,this.disableClick=!1,this.resizedown=!1,this.inRoom=!1,this.configureSocket(),Chat.socket=this.socket,this.getPlayerName()}return _createClass(e,[{key:"joinRoom",value:function(e){if(null===this.room){Chat.create(),this.createCanvas(),this.bindEvents(),CanvasChat.init();var t=document.getElementById("app");t.style.backgroundImage="none",t.style.backgroundColor="#010101",this.leaveB.style.display="inline-block",this.inRoom=!0,this.frame=requestAnimationFrame(this.gameLoop.bind(this))}else Chat.addInfoMsg("You left "+this.room.name);this.socket.emit("join room",e),Chat.addInfoMsg("You joined "+e)}},{key:"leaveRoom",value:function(){this.socket.emit("leave room"),this.inRoom=!1,this.room=null,this.leaveB.style.display="none",cancelAnimationFrame(this.frame),this.frame=null,this.fpsSpan.innerHTML="fps: 0",Chat.remove();var e=document.getElementById("app"),t=document.getElementsByClassName("game-canvas")[0];e.removeChild(t),e.removeChild(CanvasChat.chat),e.style.backgroundImage='url("../textures/misc/background.jpg")',e.style.backgroundColor="#10436f"}},{key:"startGame",value:function(){this.createMenu(),Chat.init()}},{key:"gameLoop",value:function(e){var t=e-this.lastFrameTimeMs;if(this.delta+=t,this.lastFrameTimeMs=e,this.delta>=this.timestep){var a=1e3/t;for(this.fpsSpan.innerHTML="fps: "+parseInt(a);this.delta>=this.timestep;)this.update(),this.delta-=this.timestep;this.draw()}this.frame=requestAnimationFrame(this.gameLoop.bind(this))}},{key:"update",value:function(){null!==this.room&&(this.room.updateLogic(),CanvasChat.update()),this.d={x:0,y:0},null!==this.mouse&&(this.d.x+=this.mouse.clientX-this.initialPos.x,this.d.y+=this.mouse.clientY-this.initialPos.y,Grid.move(this.d),Grid.createDrawOrder(),this.initialPos.x=this.mouse.clientX,this.initialPos.y=this.mouse.clientY,this.mouse=null)}},{key:"draw",value:function(){var e=this.canvasCtx;e.fillStyle="#010101",e.fillRect(0,0,e.canvas.width,e.canvas.height),null!==this.room&&(this.room.draw(e),CanvasChat.draw())}},{key:"bindEvents",value:function(){var e=this,t=document.getElementsByClassName("game-canvas")[0],a=document.getElementsByTagName("body")[0];a.onresize=function(){e.inRoom&&(t.height=t.clientHeight,t.width=t.clientWidth,Grid.center(t.width,t.height),Grid.createDrawOrder(),CanvasChat.chat.height=t.height,CanvasChat.chat.width=t.width,CanvasChat.defaultY=t.height/3)};var i=document.getElementsByClassName("game-chatResize")[0],n=document.getElementsByClassName("game-chat")[0],s=document.getElementsByClassName("game-hideChatButton")[0],r=document.getElementsByClassName("game-chatMessagesContainer")[0];i.onmousedown=function(t){e.resizedown=!0,e.xIni=t.clientX},t.onmousedown=function(t){e.mousedown=!0,e.initialPos.x=t.clientX,e.initialPos.y=t.clientY},document.onmousemove=function(t){if(e.inRoom)if(e.mousedown)window.getSelection().removeAllRanges(),e.mouse=t,e.disableClick=!0;else if(e.resizedown){n.style.transition="none",s.style.transition="none",window.getSelection().removeAllRanges();var o=t.clientX-e.xIni,l=n.getBoundingClientRect().width+o;l<Chat.minChatWidth?l=Chat.minChatWidth:l+5>a.clientWidth&&(l=a.clientWidth-5);var h=l-5;n.style.width=l+"px",i.style.left=h+"px",s.style.left=l+"px",r.scrollTop=r.scrollHeight,e.xIni=t.clientX}},document.onmouseup=function(t){e.inRoom&&(e.mousedown=!1,e.resizedown=!1)},t.onclick=function(t){if(!e.disableClick){var a=Grid.cellAt(t.clientX,t.clientY);null!==a&&e.socket.emit("click",a)}e.disableClick=!1};var o=document.getElementById("app");o.ondragover=function(t){e.inRoom&&t.preventDefault()},o.ondragend=function(t){e.inRoom&&t.preventDefault()},o.ondrop=function(t){if(e.inRoom){t.preventDefault();var a=t.dataTransfer.files[0];Chat.checkAndReadFile(a)}}}},{key:"createCanvas",value:function(){var e=document.getElementById("app"),t=document.createElement("canvas");t.className="game-canvas",this.canvasCtx=t.getContext("2d"),e.appendChild(t),t.height=t.clientHeight,t.width=t.clientWidth}},{key:"configureSocket",value:function(){var e=this;this.socket.on("check name",function(t){t.res?(e.player=new Player({name:t.name,client:!0}),Chat.playerName=e.player.name,document.getElementById("app").innerHTML="",e.createInfoSpans(),Assets.load(),Assets.loadAvatarImages(e.player.name,!1,e.player),e.socket.emit("new player",e.player.name)):1===t.errno?alert("Name must be 4 to 15 characters long."):2===t.errno?alert("Your name can only contain characters: a-Z, 0-9, - , _ , : and ."):3===t.errno&&alert("Your name is being used by another player.")}),this.socket.on("chat message",function(e){Chat.addMsg(e)}),this.socket.on("file message",function(e){Chat.addFileMsg(e)}),this.socket.on("online players",function(t){e.playersSpan.innerHTML="online: "+t}),this.socket.on("rooms list",function(t){e.roomsList=t,e.createRoomsWindow()}),this.socket.on("room info",function(t){e.inRoom&&(null===e.room||t.name!==e.room.name?(e.room=new Room({client:!0}),e.room.update(t),e.player=e.room.players[e.player.name],Grid.size=e.room.size,Grid.center(e.canvasCtx.canvas.width,e.canvasCtx.canvas.height),Grid.createDrawOrder(),CanvasChat.clear()):e.room.update(t),CanvasChat.players=e.room.players)}),this.socket.on("player join",function(e){Chat.addInfoMsg(e+" joined the room")}),this.socket.on("player left",function(e){Chat.addInfoMsg(e+" left the room")})}},{key:"createRoomsWindow",value:function(){var e=this,t=document.getElementById("app"),a=document.createElement("div");a.className="game-window";var i=document.createElement("button");i.className="game-closeButton",i.innerHTML="X",i.onclick=function(){t.removeChild(a)};var n=document.createElement("ul");this.roomsList.forEach(function(i){var s=document.createElement("li"),r=document.createElement("span");r.innerHTML=i.name+" | Players: "+i.players;var o=document.createElement("button");o.innerHTML="Join",o.onclick=function(){e.joinRoom(i.name),t.removeChild(a)}.bind(i),s.appendChild(r),s.appendChild(o),n.appendChild(s)}),a.appendChild(i),a.appendChild(n),t.appendChild(a)}},{key:"createMenu",value:function(){var e=this,t=document.getElementById("app"),a=document.createElement("div");a.className="game-menu",this.leaveB=document.createElement("button"),this.leaveB.style.display="none";var i=document.createElement("img");i.src="textures/icons/back.png";var n=document.createElement("button"),s=document.createElement("img");s.src="textures/icons/rooms.png",this.leaveB.onclick=function(){e.leaveRoom()},n.onclick=function(){e.socket.emit("rooms list")},this.leaveB.appendChild(i),n.appendChild(s),a.appendChild(this.leaveB),a.appendChild(n),t.appendChild(a)}},{key:"createInfoSpans",value:function(){var e=document.getElementById("app");this.fpsSpan=document.createElement("span"),this.fpsSpan.className="game-infoSpan",this.fpsSpan.innerHTML="fps: 0",e.appendChild(this.fpsSpan),this.playersSpan=document.createElement("span"),this.playersSpan.className="game-infoSpan",this.playersSpan.style.top=this.fpsSpan.clientHeight+"px",this.playersSpan.innerHTML="online: 0",e.appendChild(this.playersSpan)}},{key:"getPlayerName",value:function(){var e=this,t=document.getElementById("app"),a=document.createElement("div");a.className="game-login";var i=document.createElement("div"),n=document.createElement("input");n.type="text",n.placeholder="Nickname",n.onkeydown=function(t){n.value.trim().length>=e.maxNickLength&&46!==t.keyCode&&8!==t.keyCode&&13!==t.keyCode&&t.preventDefault()};var s=document.createElement("div"),r=document.createElement("button");r.innerHTML="<span>PLAY</span>",r.onclick=function(){var t=n.value.trim();""!==t&&e.socket.emit("check name",t)},a.onkeydown=function(e){13===e.keyCode&&r.onclick()},i.appendChild(n),s.appendChild(r),a.appendChild(i),a.appendChild(s),t.appendChild(a),n.focus()}}]),e}(),Grid={size:40,originX:0,originY:0,tileW:64,tileL:40,dx:32,dy:16,drawOrdered:[],drawPos:[],setOrigin:function(e,t){this.originX=e-this.dx,this.originY=t},center:function(e,t){var a=(2*this.size-1)*this.dy;this.originX=e/2-this.dx,this.originY=(t-a)/2},move:function(e){this.originX+=e.x,this.originY+=e.y},cellAt:function(e,t){var a=!0,i=!1,n=void 0;try{for(var s,r=this.drawOrdered[Symbol.iterator]();!(a=(s=r.next()).done);a=!0){var o=s.value,l=this.drawPos[o.y][o.x],h=e-(l.x+this.dx),d=t-(l.y+this.dy);if(Math.abs(h)/this.dx+Math.abs(d)/this.dy<=1)return o}}catch(e){i=!0,n=e}finally{try{!a&&r.return&&r.return()}finally{if(i)throw n}}return null},createDrawOrder:function(){this.drawOrdered=[],this.drawPos=[];for(var e=0;e<this.size;++e){this.drawPos.push([]);for(var t=0;t<this.size;++t)this.drawPos[e].push({})}for(var a=this.originX,i=void 0,n=this.originY,s=void 0,r=void 0,o=0;o<2*this.size-1;++o){for(o<this.size?(s=0,r=this.size-1-o,i=a-o*this.dx):(s=o-this.size+1,r=0,i=a-(2*this.size-o-2)*this.dx);s<this.size&&r<this.size;){var l={x:r,y:s},h={x:i,y:n};this.drawOrdered.push(l),this.drawPos[s][r]=h,++s,++r,i+=this.tileW}n+=this.dy}}},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),params={};params.velocity=1.3,params.framesPerImgWalk=6,params.adjustY=-84,params.adjustX=0,params.X=[0,1,1,1,0,-1,-1,-1],params.Y=[-1,-1,0,1,1,1,0,-1];var Player=function(){function e(t){_classCallCheck(this,e),this.name=t.name,this.room=t.room||null,this.pos=t.pos||null,this.status="out",this.direction=t.direction||-1,this.animFrame=-1,this.walkd={x:0,y:0},this.images=[],this.client=t.client||!1,this.target=t.target||null,this.nextPos=t.nextPos||null,this.click=null}return _createClass(e,[{key:"update",value:function(e,t){this.direction===e.direction&&this.status===e.status||this.changeAnim(e.direction,e.status),null===t||null===this.pos||this.pos.x===e.pos.x&&this.pos.y===e.pos.y||(t.updatePlayerCell(this.pos,e.pos,this.name),this.walkd={x:0,y:0}),this.pos=e.pos,this.target=e.target,this.nextPos=e.nextPos}},{key:"reset",value:function(){this.room=null,this.pos=null,this.status="out",this.direction=-1,this.animFrame=-1,this.walkd={x:0,y:0},this.images=[],this.target=null,this.nextPos=null,this.click=null}},{key:"changeAnim",value:function(e,t){this.direction=e,this.status=t,this.animFrame=-1,this.walkd={x:0,y:0}}},{key:"checkAvatarFiles",value:function(){void 0!==Assets.avatars[this.name]&&(this.avatarName=this.name)}},{key:"getPosDirection",value:function(e,t){var a={x:e.x-t.x,y:e.y-t.y};return 0===a.x&&0===a.y?this.direction:0===a.x&&a.y>0?0:a.x<0&&a.y>0?1:a.x<0&&0===a.y?2:a.x<0&&a.y<0?3:0===a.x&&a.y<0?4:a.x>0&&a.y<0?5:a.x>0&&0===a.y?6:7}},{key:"changeDirection",value:function(e){if("stand"===this.status){var t=this.getPosDirection(this.pos,e);this.direction=t}}},{key:"move",value:function(e,t){for(var a=params.X,i=params.Y,n=this.pos,s=t.size,r=[],o=0;o<s;++o){r.push([]);for(var l=0;l<s;++l)r[o].push({x:-1,y:-1})}r[n.y][n.x]={x:e.x,y:e.y};for(var h=[n];h.length>0;){var d=h[0];if(h.splice(0,1),d.x===e.x&&d.y===e.y)break;for(var c=this.getPosDirection(d,e),m=0;m<8;++m){var u=(c+m)%8,p={x:d.x+a[u],y:d.y+i[u]};if(!(p.x<0||p.x>=s||p.y<0||p.y>=s)&&!(r[p.y][p.x].x>=0)){var g=t.cell(p.x,p.y);null!==g&&(g.players.length>0||(r[p.y][p.x]=d,h.push(p)))}}}if(-1!==r[e.y][e.x].x){for(var y=r[e.y][e.x],v=e;y.x!==n.x||y.y!==n.y;)v=r[v.y][v.x],y=r[y.y][y.x];var f=this.getPosDirection(n,v),w={pos:this.pos,target:e,nextPos:v,direction:f,status:"walk"};this.update(w,t)}}},{key:"stop",value:function(){this.target=null,this.nextPos=null,this.changeAnim(this.direction,"stand")}},{key:"updateLogic",value:function(e){"stand"===this.status?this.updateLogicStand(e):"walk"===this.status&&this.updateLogicWalk(e)}},{key:"updateLogicStand",value:function(e){if(null!==this.click){var t=e.cell(this.click.x,this.click.y);null!==t&&(t.players.length>0?this.changeDirection(t.pos):this.move(t.pos,e)),this.click=null}++this.animFrame,246===this.animFrame&&(this.animFrame=0)}},{key:"updateLogicWalk",value:function(e){var t=[.5,1,.5,2,.5,1,.5,2];if(this.walkd.x+=t[this.direction]*[-2,0,2,1,2,0,-2,-1][this.direction]*params.velocity,this.walkd.y+=t[this.direction]*[-1,-1,-1,0,1,1,1,0][this.direction]*params.velocity,Math.abs(this.walkd.x/64)+Math.abs(this.walkd.y/32)>1){this.walkd.x=0,this.walkd.y=0,e.updatePlayerCell(this.pos,this.nextPos,this.name),this.pos=this.nextPos;var a=!1;if(null!==this.click){var i=e.cell(this.click.x,this.click.y);null!==i&&0===i.players.length&&(this.move(i.pos,e),a=!0),this.click=null}a||(this.nextPos.x===this.target.x&&this.nextPos.y===this.target.y||e.cell(this.target.x,this.target.y).players.length>0?this.stop():this.move(this.target,e))}++this.animFrame,this.animFrame===4*params.framesPerImgWalk&&(this.animFrame=0)}},{key:"draw",value:function(e,t){var a=this.images[this.status][this.direction];switch(this.status){case"stand":this.drawStand(e,t,a);break;case"walk":this.drawWalk(e,t,a)}}},{key:"drawStand",value:function(e,t,a){var i=Assets.getImage("shadow");e.drawImage(i,parseInt(t.x),parseInt(t.y-6)),1===a.length?e.drawImage(a[0],parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY)):this.animFrame<240?e.drawImage(a[0],parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY)):e.drawImage(a[1],parseInt(t.x+params.adjustX),parseInt(t.y+params.adjustY))}},{key:"drawWalk",value:function(e,t,a){var i=Assets.getImage("shadow");e.drawImage(i,parseInt(t.x+this.walkd.x),parseInt(t.y-6+this.walkd.y));var n=a[parseInt(this.animFrame/params.framesPerImgWalk)];e.drawImage(n,parseInt(t.x+params.adjustX+this.walkd.x),parseInt(t.y+params.adjustY+this.walkd.y))}}]),e}();"undefined"!=typeof module&&(module.exports=Player);var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),Room=function(){function e(t){_classCallCheck(this,e),this.name=t.name||"New Room",this.size=t.size||10,this.array=t.array||[],this.spawn=t.spawn||{x:0,y:0},this.spawnDirection=t.spawnDirection||4,this.players=t.players||{},this.client=t.client||!1}return _createClass(e,[{key:"update",value:function(e){var t={};for(var a in e.players){var i=void 0;void 0===this.players[a]?(i=new Player(e.players[a]),void 0===Assets.avatars[i.name]?(Assets.loadAvatarImages(i.name,!1,i),i.images=Assets.avatars.defaultAvatar):i.images=Assets.avatars[i.name]):i=this.players[a],i.client=!0,i.update(e.players[a],this),i.room=this.name,t[a]=i}this.players=t,this.name=e.name,this.size=e.size,this.array=e.array,this.spawn=e.spawn}},{key:"setPlayersRoom",value:function(){for(var e in this.players)this.players[e].room=this.name}},{key:"cell",value:function(e,t){var a=this.array[t][e];return null!==a&&(a.pos={x:e,y:t}),a}},{key:"join",value:function(e){this.players[e.name]=e,e.room=this.name,e.pos=this.spawn,e.changeAnim(this.spawnDirection,"stand");var t=this.array[this.spawn.y][this.spawn.x];t.players.push(e.name),this.array[this.spawn.y][this.spawn.x]=t}},{key:"leave",value:function(e){var t=this.players[e],a=this.array[t.pos.y][t.pos.x],i=a.players.indexOf(e);a.players.splice(i,1),this.array[t.pos.y][t.pos.x]=a,this.players[e].reset(),delete this.players[e]}},{key:"clear",value:function(){for(var e in this.players)this.leave(e)}},{key:"updatePlayerCell",value:function(e,t,a){var i=this.array[e.y][e.x],n=i.players.indexOf(a);i.players.splice(n,1),(i=this.array[t.y][t.x]).players.push(a)}},{key:"updateLogic",value:function(){for(var e in this.players)this.players[e].updateLogic(this)}},{key:"draw",value:function(e){var t=Grid.drawOrdered,a=!0,i=!1,n=void 0;try{for(var s,r=t[Symbol.iterator]();!(a=(s=r.next()).done);a=!0){var o=s.value,l=this.array[o.y][o.x];if(null!==l){var h=Grid.drawPos[o.y][o.x],d=Assets.getImage(l.material);e.drawImage(d,parseInt(h.x),parseInt(h.y))}}}catch(e){i=!0,n=e}finally{try{!a&&r.return&&r.return()}finally{if(i)throw n}}var c=!0,m=!1,u=void 0;try{for(var p,g=t[Symbol.iterator]();!(c=(p=g.next()).done);c=!0){var y=p.value,v=this.array[y.y][y.x];if(null!==v&&v.players.length>0){var f=Grid.drawPos[y.y][y.x],w=!0,C=!1,x=void 0;try{for(var b,k=v.players[Symbol.iterator]();!(w=(b=k.next()).done);w=!0){var E=b.value;this.players[E].draw(e,f)}}catch(e){C=!0,x=e}finally{try{!w&&k.return&&k.return()}finally{if(C)throw x}}}}}catch(e){m=!0,u=e}finally{try{!c&&g.return&&g.return()}finally{if(m)throw u}}}}]),e}();"undefined"!=typeof module&&(module.exports=Room);var WavRecorder={available:!1,sampleRate:null,volume:1,leftchannel:[],rightchannel:[],recordingLength:0,recording:!1,init:function(){navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(WavRecorder.success).catch(function(e){alert("Audio capture not supported in this browser.")})},success:function(e){window.AudioContext=window.AudioContext||window.webKitAudioContext;var t=WavRecorder;t.available=!0;var a=new AudioContext;t.sampleRate=a.sampleRate;var i=a.createScriptProcessor(1024,2,2);i.onaudioprocess=function(e){if(t.recording){var a=e.inputBuffer.getChannelData(0),i=e.inputBuffer.getChannelData(1);t.leftchannel.push(new Float32Array(a)),t.rightchannel.push(new Float32Array(i)),t.recordingLength+=1024}},a.createMediaStreamSource(e).connect(i),i.connect(a.destination)},start:function(){this.recording=!0,this.leftchannel=[],this.rightchannel=[],this.recordingLength=0},cancel:function(){this.recording=!1},stop:function(){this.recording=!1;var e=this.mergeBuffers(this.leftchannel,this.recordingLength),t=this.mergeBuffers(this.rightchannel,this.recordingLength),a=this.interleave(e,t),i=new ArrayBuffer(44+2*a.length),n=new DataView(i);this.writeUTFBytes(n,0,"RIFF"),n.setUint32(4,44+2*a.length,!0),this.writeUTFBytes(n,8,"WAVE"),this.writeUTFBytes(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,2,!0),n.setUint32(24,this.sampleRate,!0),n.setUint32(28,4*this.sampleRate,!0),n.setUint16(32,4,!0),n.setUint16(34,16,!0),this.writeUTFBytes(n,36,"data"),n.setUint32(40,2*a.length,!0);for(var s=a.length,r=44,o=this.volume,l=0;l<s;++l)n.setInt16(r,a[l]*(32767*o),!0),r+=2;return new Blob([n],{type:"audio/wav"})},mergeBuffers:function(e,t){for(var a=new Float32Array(t),i=0,n=e.length,s=0;s<n;++s){var r=e[s];a.set(r,i),i+=r.length}return a},interleave:function(e,t){for(var a=e.length+t.length,i=new Float32Array(a),n=e.length,s=0,r=0;r<n;++r)i[s++]=e[r],i[s++]=t[r];return i},writeUTFBytes:function(e,t,a){for(var i=a.length,n=0;n<i;++n)e.setUint8(t+n,a.charCodeAt(n))}};