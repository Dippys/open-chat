"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Assets={images:{},imgLoaded:0,imgFiles:[],load:function(){this.fillFileArrays(),this.loadImages()},loadImages:function(){var e=this,t=new Image;t.src=this.imgFiles[this.imgLoaded],t.onload=function(){var s=t.src.split("/"),i=s[s.length-1].split(".")[0];e.images[i]=t,++e.imgLoaded,e.imgLoaded<e.imgFiles.length?e.loadImages():game.startGame()}},getImage:function(e){return this.images[e]},getImgArray:function(e){var t=[];for(var s in this.images)0===s.indexOf(e)&&t.push(this.images[s]);return t},fillFileArrays:function(){var e="./textures/floor/";this.imgFiles.push(e+"grass.png"),e="./textures/character/",this.imgFiles.push(e+"sam0stand.png"),this.imgFiles.push(e+"sam0walk-1.png"),this.imgFiles.push(e+"sam0walk-2.png"),this.imgFiles.push(e+"sam0walk-3.png"),this.imgFiles.push(e+"sam0walk-4.png"),this.imgFiles.push(e+"sam1stand.png"),this.imgFiles.push(e+"sam1walk-1.png"),this.imgFiles.push(e+"sam1walk-2.png"),this.imgFiles.push(e+"sam1walk-3.png"),this.imgFiles.push(e+"sam1walk-4.png"),this.imgFiles.push(e+"sam2stand.png"),this.imgFiles.push(e+"sam2walk-1.png"),this.imgFiles.push(e+"sam2walk-2.png"),this.imgFiles.push(e+"sam2walk-3.png"),this.imgFiles.push(e+"sam2walk-4.png"),this.imgFiles.push(e+"sam3stand-1.png"),this.imgFiles.push(e+"sam3stand-2.png"),this.imgFiles.push(e+"sam3walk-1.png"),this.imgFiles.push(e+"sam3walk-2.png"),this.imgFiles.push(e+"sam3walk-3.png"),this.imgFiles.push(e+"sam3walk-4.png"),this.imgFiles.push(e+"sam4stand-1.png"),this.imgFiles.push(e+"sam4stand-2.png"),this.imgFiles.push(e+"sam4walk-1.png"),this.imgFiles.push(e+"sam4walk-2.png"),this.imgFiles.push(e+"sam4walk-3.png"),this.imgFiles.push(e+"sam4walk-4.png"),this.imgFiles.push(e+"sam5stand-1.png"),this.imgFiles.push(e+"sam5stand-2.png"),this.imgFiles.push(e+"sam5walk-1.png"),this.imgFiles.push(e+"sam5walk-2.png"),this.imgFiles.push(e+"sam5walk-3.png"),this.imgFiles.push(e+"sam6stand-1.png"),this.imgFiles.push(e+"sam6stand-2.png"),this.imgFiles.push(e+"sam6walk-1.png"),this.imgFiles.push(e+"sam6walk-2.png"),this.imgFiles.push(e+"sam6walk-3.png"),this.imgFiles.push(e+"sam6walk-4.png"),this.imgFiles.push(e+"sam7stand-1.png"),this.imgFiles.push(e+"sam7stand-2.png"),this.imgFiles.push(e+"sam7walk-1.png"),this.imgFiles.push(e+"sam7walk-2.png"),this.imgFiles.push(e+"sam7walk-3.png"),this.imgFiles.push(e+"sam7walk-4.png"),this.imgFiles.push(e+"shadow.png")}},_createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),Game=function(){function e(){_classCallCheck(this,e),console.log("Initializing Game..."),this.socket=null,this.playerName=null,this.player=null,this.room=null,this.canvasCtx=null,this.lastFrameTimeMs=0,this.d={x:0,y:0},this.initialPos={x:0,y:0},this.mouse={cType:"checked"},this.mousedown=!1,this.disableClick=!1,this.getPlayerName()}return _createClass(e,[{key:"init",value:function(){this.createChatPanel(),this.socket=io(),this.configureSocket(),this.bindChatEvents(),this.createCanvas(),this.bindEvents(),Assets.load()}},{key:"startGame",value:function(){this.socket.emit("join room",this.roomsList[0]),requestAnimationFrame(this.gameLoop.bind(this))}},{key:"gameLoop",value:function(e){var t=1e3/(e-this.lastFrameTimeMs);this.fpsSpan.innerHTML="fps: "+Math.ceil(t),this.lastFrameTimeMs=e,this.update(),this.draw(),requestAnimationFrame(this.gameLoop.bind(this))}},{key:"update",value:function(){null!==this.room&&(this.mouse=this.room.updateLogic(this.mouse,this.playerName)),this.d={x:0,y:0},"dragged"===this.mouse.cType&&(this.d.x+=this.mouse.clientX-this.initialPos.x,this.d.y+=this.mouse.clientY-this.initialPos.y,Grid.move(this.d),Grid.createDrawOrder(),this.initialPos.x=this.mouse.clientX,this.initialPos.y=this.mouse.clientY,this.mouse.cType="checked")}},{key:"draw",value:function(){var e=this.canvasCtx;e.fillStyle="#010101",e.fillRect(0,0,e.canvas.width,e.canvas.height),null!==this.room&&this.room.draw(e)}},{key:"bindEvents",value:function(){var e=this,t=document.getElementsByClassName("game-canvas")[0];document.getElementsByTagName("body")[0].onresize=function(){t.height=t.clientHeight,t.width=t.clientWidth,Grid.center(t.width,t.height),Grid.createDrawOrder()},t.onmousedown=function(t){e.mousedown=!0,e.initialPos.x=t.clientX,e.initialPos.y=t.clientY},document.onmousemove=function(t){e.mousedown&&(e.mouse=t,e.mouse.cType="dragged",e.disableClick=!0)},document.onmouseup=function(t){e.mousedown=!1},t.onclick=function(t){e.disableClick||(e.mouse=t,e.mouse.cType="clicked"),e.disableClick=!1}}},{key:"createCanvas",value:function(){var e=document.getElementById("app"),t=document.createElement("canvas");t.className="game-canvas",this.canvasCtx=t.getContext("2d"),e.appendChild(t),t.height=t.clientHeight,t.width=t.clientWidth,this.fpsSpan=document.createElement("span"),this.fpsSpan.style="position: absolute; right: 0; color: #ffffff;",this.fpsSpan.innerHTML="XX",e.appendChild(this.fpsSpan),this.playersSpan=document.createElement("span"),this.playersSpan.style="position: absolute; right: 0; color: #ffffff; top: "+this.fpsSpan.clientHeight+"px;",this.playersSpan.innerHTML="YY",e.appendChild(this.playersSpan)}},{key:"configureSocket",value:function(){var e=this;this.socket.emit("new player",this.playerName),this.socket.on("chat message",function(t){e.addChatMessage(t.player,t.msg)}),this.socket.on("rooms list",function(t){e.roomsList=t}),this.socket.on("room info",function(t){null===e.room?(e.room=new Room({a:0}),e.room.update(t),e.player=e.room.getPlayer(e.playerName),e.player.setSocket(e.socket),Grid.setSize(e.room.getSize()),Grid.center(e.canvasCtx.canvas.width,e.canvasCtx.canvas.height),Grid.createDrawOrder()):e.room.update(t)}),this.socket.on("online players",function(t){e.playersSpan.innerHTML="online: "+t})}},{key:"createChatPanel",value:function(){var e=document.getElementById("app"),t=document.createElement("div");t.className="game-chat";var s=document.createElement("div");s.className="game-chatMessagesContainer";var i=document.createElement("div");i.className="game-chatInput",this.chatInput=document.createElement("input"),this.chatInput.type="text",i.appendChild(this.chatInput),t.appendChild(s),t.appendChild(i),e.appendChild(t)}},{key:"bindChatEvents",value:function(){var e=this;this.chatInput.onkeypress=function(t){var s=e.chatInput.value.trim();13===t.keyCode&&""!==s&&(e.chatInput.value="",e.socket.emit("chat message",s),e.addChatMessage(e.playerName,s))}}},{key:"addChatMessage",value:function(e,t){var s=document.createElement("div");s.className="game-chatMessage";var i=document.createElement("span"),a=document.createElement("span");a.className="game-boldText",a.textContent=e+": ";var n=document.createTextNode(t);i.appendChild(a),i.appendChild(n),s.appendChild(i);var r=document.getElementsByClassName("game-chatMessagesContainer")[0];r.appendChild(s),r.scrollTop=r.scrollHeight}},{key:"getPlayerName",value:function(){var e=this,t=document.getElementById("app"),s=document.createElement("div");s.className="game-centered";var i=document.createElement("div");i.className="game-horizontalLayout";var a=document.createElement("div");a.className="game-horizontalLayout";var n=document.createElement("span");n.className="game-label",n.innerHTML="Nickname:";var r=document.createElement("div");r.className="game-horizontalLayout";var l=document.createElement("input");l.type="text";var h=document.createElement("div");h.className="game-horizontalLayout";var o=document.createElement("button");o.className="game-horizontalCentered",o.innerHTML="Play",o.onclick=function(){var s=l.value.trim();""!==s&&(e.playerName=s,t.innerHTML="",e.init())},s.onkeydown=function(e){13===e.keyCode&&o.onclick()},a.appendChild(n),r.appendChild(l),i.appendChild(a),i.appendChild(r),h.appendChild(o),s.appendChild(i),s.appendChild(h),t.appendChild(s),l.focus()}}]),e}(),Grid={size:40,originX:0,originY:0,tileW:65,tileL:39,dx:32,dy:16,drawOrdered:[],X:[0,1,1,1,0,-1,-1,-1],Y:[-1,-1,0,1,1,1,0,-1],setSize:function(e){this.size=e},setOrigin:function(e,t){this.originX=e-this.dx,this.originY=t},center:function(e,t){var s=(2*this.size-1)*this.dy;this.originX=e/2-this.dx,this.originY=(t-s)/2},move:function(e){this.originX+=e.x,this.originY+=e.y},getDrawOrdered:function(){return this.drawOrdered},cellAt:function(e,t){var s=!0,i=!1,a=void 0;try{for(var n,r=this.drawOrdered[Symbol.iterator]();!(s=(n=r.next()).done);s=!0){var l=n.value,h=e-(l.drawPos.x+this.dx),o=t-(l.drawPos.y+this.dy);if(Math.abs(h)/this.dx+Math.abs(o)/this.dy<=1)return{x:l.x,y:l.y}}}catch(e){i=!0,a=e}finally{try{!s&&r.return&&r.return()}finally{if(i)throw a}}return null},createDrawOrder:function(){this.drawOrdered=[];for(var e=this.originX,t=void 0,s=this.originY,i=void 0,a=void 0,n=0;n<2*this.size-1;++n){for(n<this.size?(i=0,a=this.size-1-n,t=e-n*this.dx):(i=n-this.size+1,a=0,t=e-(2*this.size-n-2)*this.dx);i<this.size&&a<this.size;){var r={x:a,y:i,drawPos:{x:t,y:s}};this.drawOrdered.push(r),++i,++a,t+=this.tileW}s+=this.dy}}},_createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),Player=function(){function e(t){_classCallCheck(this,e),this.name=t.name,this.room=t.room||null,this.pos=t.pos||null,this.adjustY=-69,this.character="sam",this.status="out",this.direction=t.direction||-1,this.animFrame=0,this.images=[],this.walkd={x:0,y:0},this.target=t.target||null,this.nextPos=t.nextPos||null,this.socket=null}return _createClass(e,[{key:"update",value:function(e){this.direction===e.direction&&this.status===e.status||this.setDirAndStatus(e.direction,e.status),this.pos=e.pos,this.target=e.target,this.nextPos=e.nextPos}},{key:"setRoom",value:function(e){this.room=e}},{key:"setPos",value:function(e){this.pos=e}},{key:"setSocket",value:function(e){this.socket=e}},{key:"setDirection",value:function(e){this.direction=e}},{key:"setStatus",value:function(e){this.status=e}},{key:"setDirAndStatus",value:function(e,t){this.direction=e,this.status=t,this.animFrame=0,this.walkd={x:0,y:0},this.fetchImages()}},{key:"getName",value:function(){return this.name}},{key:"getRoom",value:function(){return this.room}},{key:"getPos",value:function(){return this.pos}},{key:"getStatus",value:function(){return this.status}},{key:"getDirection",value:function(){return this.direction}},{key:"fetchImages",value:function(){var e=this.character+this.direction+this.status;this.images=Assets.getImgArray(e)}},{key:"getPosDirection",value:function(e,t){var s={x:e.x-t.x,y:e.y-t.y};return 0===s.x&&0===s.y?this.direction:0===s.x&&s.y>0?0:s.x<0&&s.y>0?1:s.x<0&&0===s.y?2:s.x<0&&s.y<0?3:0===s.x&&s.y<0?4:s.x>0&&s.y<0?5:s.x>0&&0===s.y?6:7}},{key:"changeDirection",value:function(e){if("stand"===this.status){var t=this.getPosDirection(this.pos,e);this.direction=t,this.fetchImages(),this.socket.emit("change direction",t)}}},{key:"move",value:function(e,t,s){for(var i=Grid.X,a=Grid.Y,n=this.pos,r=t.getSize(),l=[],h=0;h<r;++h){l.push([]);for(var o=0;o<r;++o)l[h].push({x:-1,y:-1})}l[n.y][n.x]={x:e.x,y:e.y};for(var u=[n];u.length>0;){var c=u[0];if(u.splice(0,1),c.x===e.x&&c.y===e.y)break;for(var m=this.getPosDirection(c,e),d=0;d<8;++d){var p=(m+d)%8,g={x:c.x+i[p],y:c.y+a[p]};if(!(g.x<0||g.x>=r||g.y<0||g.y>=r)&&!(l[g.y][g.x].x>=0)){var y=t.cell(g.x,g.y);null!==y&&(y.players.length>0||(l[g.y][g.x]=c,u.push(g)))}}}if(-1!==l[e.y][e.x].x){for(var f=l[e.y][e.x],v=e;f.x!==n.x||f.y!==n.y;)v=l[v.y][v.x],f=l[f.y][f.x];var k=this.getPosDirection(n,v),w={pos:this.pos,target:e,nextPos:v,direction:k,status:"walk"},x=this.target;this.update(w),this.name===s&&(null===x||x.x!==e.x||x.y!==e.y?this.socket.emit("start-move",w):this.socket.emit("move",w))}}},{key:"stop",value:function(e){this.target=null,this.nextPos=null,this.setDirAndStatus(this.direction,"stand"),this.name===e&&this.socket.emit("end-move")}},{key:"updateLogic",value:function(e,t,s){return"stand"===this.status?this.updateLogicStand(e,t,s):"walk"===this.status&&this.updateLogicWalk(e,t,s),t}},{key:"updateLogicStand",value:function(e,t,s){if("clicked"===t.cType&&this.name===s){var i=e.cellAt(t.clientX,t.clientY);null!==i&&(i.players.length>0?this.changeDirection(i.pos):this.move(i.pos,e,s)),t.cType="checked"}}},{key:"updateLogicWalk",value:function(e,t,s){var i=[-2,0,2,1,2,0,-2,-1],a=[-1,-1,-1,0,1,1,1,0],n=[.5,1,.5,2,.5,1,.5,2];if(this.walkd.x+=n[this.direction]*i[this.direction],this.walkd.y+=n[this.direction]*a[this.direction],Math.abs(this.walkd.x/64)+Math.abs(this.walkd.y/32)>1){if(this.walkd.x=0,this.walkd.y=0,e.updatePlayerCell(this.pos,this.nextPos,this.name),this.pos=this.nextPos,"clicked"===t.cType&&this.name===s){var r=e.cellAt(t.clientX,t.clientY);if(null!==r&&0===r.players.length)return this.move(r.pos,e,s),t.cType="checked",t;t.cType="checked"}this.nextPos.x===this.target.x&&this.nextPos.y===this.target.y||e.cell(this.target.x,this.target.y).players.length>0?this.stop(s):this.move(this.target,e,s)}}},{key:"draw",value:function(e,t){switch(this.status){case"stand":this.drawStand(e,t);break;case"walk":this.drawWalk(e,t)}}},{key:"drawStand",value:function(e,t){var s=Assets.getImage("shadow");e.drawImage(s,t.x,t.y-6),1===this.images.length?e.drawImage(this.images[0],t.x,t.y+this.adjustY):(this.animFrame<240?e.drawImage(this.images[0],t.x,t.y+this.adjustY):e.drawImage(this.images[1],t.x,t.y+this.adjustY),++this.animFrame,246===this.animFrame&&(this.animFrame=0))}},{key:"drawWalk",value:function(e,t){var s=Assets.getImage("shadow");e.drawImage(s,t.x+this.walkd.x,t.y-6+this.walkd.y);var i=this.images[parseInt(this.animFrame/6)];e.drawImage(i,t.x+this.walkd.x,t.y+this.adjustY+this.walkd.y),++this.animFrame,this.animFrame===6*this.images.length&&(this.animFrame=0)}}]),e}();"undefined"!=typeof module&&(module.exports=Player);var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),Room=function(){function e(t){_classCallCheck(this,e),this.name=t.name||"New Room",this.size=t.size||10,this.array=t.array||[],this.spawn=t.spawn||{x:0,y:0},this.spawnDirection=t.spawnDirection||4,this.players=t.players||{}}return _createClass(e,[{key:"update",value:function(e){var t={};for(var s in e.players){var i=void 0;(i=void 0===this.players[s]?new Player(e.players[s]):this.players[s]).update(e.players[s]),t[s]=i}this.players=t,this.name=e.name,this.size=e.size,this.array=e.array,this.spawn=e.spawn}},{key:"cell",value:function(e,t){return this.array[t][e]}},{key:"cellAt",value:function(e,t){var s=Grid.cellAt(e,t);if(null===s)return s;var i=this.array[s.y][s.x];return null!==i&&(i.pos=s),i}},{key:"setName",value:function(e){this.name=e}},{key:"setSize",value:function(e){this.size=e}},{key:"setSpawn",value:function(e,t){this.spawn={x:e,y:t}}},{key:"join",value:function(e){this.players[e.getName()]=e,e.setRoom(this.name),e.setPos(this.spawn),e.setStatus("stand"),e.setDirection(this.spawnDirection);var t=this.array[this.spawn.y][this.spawn.x];t.players.push(e.getName()),this.array[this.spawn.y][this.spawn.x]=t}},{key:"leave",value:function(e){var t=this.players[e],s=this.array[t.getPos().y][t.getPos().x],i=s.players.indexOf(e);s.players.splice(i,1),this.array[t.getPos().y][t.getPos().x]=s,this.players[e].setRoom(null),this.players[e].setPos(null),delete this.players[e]}},{key:"clear",value:function(){for(var e in this.players)this.leave(e)}},{key:"getName",value:function(){return this.name}},{key:"getSize",value:function(){return this.size}},{key:"getSpawn",value:function(){return this.spawn}},{key:"getPlayer",value:function(e){return this.players[e]}},{key:"getPlayers",value:function(){return this.players}},{key:"updatePlayerCell",value:function(e,t,s){var i=this.array[e.y][e.x],a=i.players.indexOf(s);i.players.splice(a,1),(i=this.array[t.y][t.x]).players.push(s)}},{key:"updateLogic",value:function(e,t){for(var s in this.players)e=this.players[s].updateLogic(this,e,t);return e}},{key:"draw",value:function(e){var t=Grid.getDrawOrdered(),s=!0,i=!1,a=void 0;try{for(var n,r=t[Symbol.iterator]();!(s=(n=r.next()).done);s=!0){var l=n.value,h=this.array[l.y][l.x];if(null!==h){var o=Assets.getImage(h.material);e.drawImage(o,l.drawPos.x,l.drawPos.y)}}}catch(e){i=!0,a=e}finally{try{!s&&r.return&&r.return()}finally{if(i)throw a}}var u=!0,c=!1,m=void 0;try{for(var d,p=t[Symbol.iterator]();!(u=(d=p.next()).done);u=!0){var g=d.value,y=this.array[g.y][g.x];if(null!==y&&y.players.length>0){var f=!0,v=!1,k=void 0;try{for(var w,x=y.players[Symbol.iterator]();!(f=(w=x.next()).done);f=!0){var C=w.value;this.players[C].draw(e,g.drawPos)}}catch(e){v=!0,k=e}finally{try{!f&&x.return&&x.return()}finally{if(v)throw k}}}}}catch(e){c=!0,m=e}finally{try{!u&&p.return&&p.return()}finally{if(c)throw m}}}}]),e}();"undefined"!=typeof module&&(module.exports=Room);