"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Assets=function(){function Assets(game){_classCallCheck(this,Assets);this.game=game;this.floors={};this.loadFloors()}_createClass(Assets,[{key:"loadFloors",value:function loadFloors(){var _this=this;var tile=new Image;tile.src="./textures/floor/grass.png";var loaded=false;tile.onload=function(){_this.floors["grass"]=tile;_this.game.loaded=true}}},{key:"getFloor",value:function getFloor(floor){return this.floors[floor]}}]);return Assets}();"use strict";var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Game=function(){function Game(){_classCallCheck(this,Game);console.log("Initializing Game...");this.socket=null;this.playerName=null;this.room=null;this.canvasCtx=null;this.loaded=false;this.assets=null;this.fps=20;this.timestep=1e3/this.fps;this.lastFrameTimeMs=0;this.delta=0;this.d={x:0,y:0};this.initialPos={x:0,y:0};this.mouse=null;this.mousedown=false;this.getPlayerName()}_createClass(Game,[{key:"start",value:function start(){this.assets=new Assets(this);this.createChatPanel();this.socket=io();this.configureSocket();this.bindChatEvents();this.createCanvas();this.bindEvents();requestAnimationFrame(this.gameLoop.bind(this))}},{key:"gameLoop",value:function gameLoop(timestamp){if(!this.loaded){this.lastFrameTimeMs=0}if(timestamp<this.lastFrameTimeMs+1e3/this.fps){requestAnimationFrame(this.gameLoop.bind(this));return}this.delta+=timestamp-this.lastFrameTimeMs;var fps=1e3/(timestamp-this.lastFrameTimeMs);this.fpsSpan.innerHTML="fps: "+Math.ceil(fps);this.lastFrameTimeMs=timestamp;this.d={x:0,y:0};var i=0;while(this.delta>=this.timestep){this.update();this.delta-=this.timestep;if(i++>150){this.panic();break}}this.draw();requestAnimationFrame(this.gameLoop.bind(this))}},{key:"update",value:function update(){if(this.mouse!==null){this.d.x+=this.mouse.clientX-this.initialPos.x;this.d.y+=this.mouse.clientY-this.initialPos.y;this.initialPos.x=this.mouse.clientX;this.initialPos.y=this.mouse.clientY;this.mouse=null}}},{key:"panic",value:function panic(){this.delta=0}},{key:"draw",value:function draw(){var ctx=this.canvasCtx;ctx.fillStyle="#010101";ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);if(this.room!==null){this.room.draw(ctx,this.d,this.assets.getFloor("grass"))}}},{key:"bindEvents",value:function bindEvents(){var _this=this;var canvas=document.getElementsByClassName("game-canvas")[0];var body=document.getElementsByTagName("body")[0];body.onresize=function(){canvas.height=canvas.clientHeight;canvas.width=canvas.clientWidth};canvas.onmousedown=function(e){_this.mousedown=true;_this.initialPos.x=e.clientX;_this.initialPos.y=e.clientY};document.onmousemove=function(e){if(_this.mousedown){_this.mouse=e}};document.onmouseup=function(e){_this.mousedown=false}}},{key:"createCanvas",value:function createCanvas(){var app=document.getElementById("app");var canvas=document.createElement("canvas");canvas.className="game-canvas";this.canvasCtx=canvas.getContext("2d");app.appendChild(canvas);canvas.height=canvas.clientHeight;canvas.width=canvas.clientWidth;this.fpsSpan=document.createElement("span");this.fpsSpan.style="position: absolute; right: 0; color: #ffffff;";this.fpsSpan.innerHTML="XX";app.appendChild(this.fpsSpan);this.playersSpan=document.createElement("span");this.playersSpan.style="position: absolute; right: 0; color: #ffffff;"+" top: "+this.fpsSpan.clientHeight+"px;";this.playersSpan.innerHTML="YY";app.appendChild(this.playersSpan)}},{key:"configureSocket",value:function configureSocket(){var _this2=this;this.socket.emit("new player",this.playerName);this.socket.on("chat message",function(chatMsg){_this2.addChatMessage(chatMsg.player,chatMsg.msg)});this.socket.on("rooms list",function(rooms){_this2.socket.emit("join room",rooms[0])});this.socket.on("room info",function(room){room=_extends({},room,{initPos:{x:_this2.canvasCtx.canvas.clientWidth/2-65/2,y:0}});_this2.room=new Room(room)});this.socket.on("online players",function(num_players){_this2.playersSpan.innerHTML="online: "+num_players})}},{key:"createChatPanel",value:function createChatPanel(){var app=document.getElementById("app");var chatC=document.createElement("div");chatC.className="game-chat";var chatMessagesC=document.createElement("div");chatMessagesC.className="game-chatMessagesContainer";var chatInputC=document.createElement("div");chatInputC.className="game-chatInput";this.chatInput=document.createElement("input");this.chatInput.type="text";chatInputC.appendChild(this.chatInput);chatC.appendChild(chatMessagesC);chatC.appendChild(chatInputC);app.appendChild(chatC)}},{key:"bindChatEvents",value:function bindChatEvents(){var _this3=this;this.chatInput.onkeypress=function(e){var msg=_this3.chatInput.value.trim();if(e.keyCode===13&&msg!==""){_this3.chatInput.value="";_this3.socket.emit("chat message",msg);_this3.addChatMessage(_this3.playerName,msg)}}}},{key:"addChatMessage",value:function addChatMessage(player,msg){var msgC=document.createElement("div");msgC.className="game-chatMessage";var msgSpan=document.createElement("span");var nameSpan=document.createElement("span");nameSpan.className="game-boldText";nameSpan.textContent=player+": ";var msgNode=document.createTextNode(msg);msgSpan.appendChild(nameSpan);msgSpan.appendChild(msgNode);msgC.appendChild(msgSpan);var chat=document.getElementsByClassName("game-chatMessagesContainer")[0];chat.appendChild(msgC);chat.scrollTop=chat.scrollHeight}},{key:"getPlayerName",value:function getPlayerName(){var _this4=this;var app=document.getElementById("app");var menu=document.createElement("div");menu.className="game-centered";var nickContainer=document.createElement("div");nickContainer.className="game-horizontalLayout";var nickLabel=document.createElement("div");nickLabel.className="game-horizontalLayout";var nickSpan=document.createElement("span");nickSpan.className="game-label";nickSpan.innerHTML="Nickname:";var nickInputContainer=document.createElement("div");nickInputContainer.className="game-horizontalLayout";var nickInput=document.createElement("input");nickInput.type="text";var buttonC=document.createElement("div");buttonC.className="game-horizontalLayout";var button=document.createElement("button");button.className="game-horizontalCentered";button.innerHTML="Play";button.onclick=function(){var nick=nickInput.value.trim();if(nick!==""){_this4.playerName=nick;app.innerHTML="";_this4.start()}};menu.onkeydown=function(e){if(e.keyCode===13){button.onclick()}};nickLabel.appendChild(nickSpan);nickInputContainer.appendChild(nickInput);nickContainer.appendChild(nickLabel);nickContainer.appendChild(nickInputContainer);buttonC.appendChild(button);menu.appendChild(nickContainer);menu.appendChild(buttonC);app.appendChild(menu);nickInput.focus()}}]);return Game}();"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Player=function(){function Player(player){_classCallCheck(this,Player);this.name=player.name;this.room=player.room||null;this.pos=player.pos||null}_createClass(Player,[{key:"setRoom",value:function setRoom(room){this.room=room}},{key:"setPos",value:function setPos(pos){this.pos=pos}},{key:"getName",value:function getName(){return this.name}},{key:"getRoom",value:function getRoom(){return this.room}},{key:"getPos",value:function getPos(){return this.pos}}]);return Player}();if(typeof module!=="undefined"){module.exports=Player}"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Room=function(){function Room(room){_classCallCheck(this,Room);this.name=room.name;this.width=room.width;this.length=room.length;this.spawn=room.spawn||[0,0];this.players=room.players||{};this.initPos=room.initPos}_createClass(Room,[{key:"setName",value:function setName(name){this.name=name}},{key:"setWidth",value:function setWidth(width){this.width=width}},{key:"setLength",value:function setLength(length){this.length=length}},{key:"setSpawn",value:function setSpawn(x,y){this.spawn=[x,y]}},{key:"join",value:function join(player){this.players[player.getName()]=player;player.setRoom(this.name);player.setPos(this.spawn)}},{key:"leave",value:function leave(playerName){this.players[playerName].setRoom(null);this.players[playerName].setPos(null);delete this.players[playerName]}},{key:"clear",value:function clear(){for(var player in this.players){this.leave(player)}}},{key:"getName",value:function getName(){return this.name}},{key:"getWidth",value:function getWidth(){return this.width}},{key:"getLength",value:function getLength(){return this.length}},{key:"getSpawn",value:function getSpawn(){return this.spawn}},{key:"getPlayers",value:function getPlayers(){return this.players}},{key:"draw",value:function draw(ctx,d,tile){var w=65;var l=39;var xdx=0;var xdy=0;var ydx=32;var ydy=16;this.initPos.x+=d.x;this.initPos.y+=d.y;var x0=this.initPos.x;var y0=this.initPos.y;for(var i=0;i<this.width;++i){var x=x0-i*ydx;var y=y0+i*ydy;for(var j=0;j<=i;++j){ctx.drawImage(tile,x,y,w,l);x+=w}}var nx=x0-8*ydx;var ny=y0+10*ydy;for(var _i=0;_i<this.width-1;++_i){var _x=nx+_i*ydx;var _y=ny+_i*ydy;for(var _j=0;_j<this.width-1-_i;++_j){ctx.drawImage(tile,_x,_y,w,l);_x+=w}}}}]);return Room}();if(typeof module!=="undefined"){module.exports=Room}
